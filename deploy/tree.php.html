
<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="cache-control" content="max-age=0" />
<meta http-equiv="cache-control" content="no-cache" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
<meta http-equiv="pragma" content="no-cache" />
<meta name=viewport content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/css/vendor/bootstrap/bootstrap-rendering.css">
<link rel="stylesheet" href="/css/vendor/bootstrap/custom.css">
<link href="/s3assets/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">

<link href='/css/tree-fonts.css' rel='stylesheet' type='text/css'>
<script src="/s3assets/jquery.min.js"></script>
<script type="text/javascript">
if (typeof jQuery == 'undefined') {
    document.write(unescape("%3Cscript src='/js/jquery-1.12.4.min.js' type='text/javascript'%3E%3C/script%3E"));
}
</script>
<link rel="stylesheet" href="/s3assets/jquery-ui.css">
<script src="/s3assets/jquery-ui.min.js"></script>
<script src="/s3assets/jquery-ui-i18n.min.js"></script>
<style>
.btn{
    white-space:normal !important;
    word-wrap:break-word; 
    padding-left: 10px;
    padding-right: 10px;
 }
 

.permalink{
    margin-top: -7px;
}

.required-error {
    border: 2px red solid;
}


.ztdisabled {
  color: #999999;
  text-decoration: none;
  background-color: transparent;
  cursor: not-allowed;
  pointer-events: none;  
  opacity: 0.65
}

.zt-confirmation {
  font-weight: bold;  
  font-style: italic;   
  color: red; 
}

/* traffic view in tree preview */
.traffic-display
{
    font-style: italic;
    font-size: 80%;
}

/* print pagination */
.zingtree-node {
   page-break-before: always;
}
</style>
<script>


// uploads the file to our S3 account
// updates the form with the location URL

function on_upload_submit(target_form_id, location_field, expiration)
{

    // validate the file name in case it has weird characters (like commas, etc.)

    var fname = this.event.target.files[0].name ;
    if (!fname.match(/^[0-9a-zA-Z_\-. ()]+$/))
    {
        alert('Filename contains illegal characters. Please rename and upload again.');
        return (false) ;
    }

    // get all the data from the form

    data = new FormData($('#upload-'+target_form_id + '-' + location_field)[0]);


    // set temporary bucket if we have an expiration set

    var url = 'https://uploads.zingtree.com' ;

    // send the file with the S3 parameters

    var request = $.ajax({
        url: url,
        data: data,
        cache: false,
        contentType: false,
        processData: false,
        type: 'POST'
    }) ;

    // process success
    request.done(function( msg ) {

        // get URL of uploaded file

        var location = decodeURI(msg.getElementsByTagName("Location")[0].childNodes[0].nodeValue) ;
        location = location.replace("%2F", "/") ;

        // make secure link
        location = location.replace ("http:", "https:") ;

        // and uploaded file name
        var file = msg.getElementsByTagName("Key")[0].childNodes[0].nodeValue ;

        if (expiration == 0)
            file = decodeURI(file.replace ("docs/", "")) ;
        else
            file = decodeURI(file.replace ("tempdocs/", "")) ;


        // add the location to the target form and hidden field, and insert file name into button

        if (file != '')
        {
            $("#filelabel-"+target_form_id+"-"+location_field).html('<i class="fa fa-check-square" aria-hidden="true"></i> Attachment: <b><i>'+file+'</i></b>') ;
            $('#'+target_form_id + ' input[name=' + location_field + ']').val(location) ;

            // if we have a logo save button, enabled it
            $('#upload-save-button').prop('disabled', false);

            // show the image if we have a upload-img-src image tag
            $('#upload-img-src').attr('src', location) ;
        }


        // cancel? restore initial state and delete attachment URL upload field

        else
        {
            $(".attachment-label").html('Add Attachment') ;
            $('#'+target_form_id + ' input[name=' + location_field + ']').val('') ;
        }

    }) ;

    return (false) ;

}
    
</script>
<link rel="stylesheet" href="https://zingtree.com/css/custom-css.php?template=anim-apps&body_text=404b55&primary=308ca3&secondary=ff3801&complement=ffa902">
<link rel="stylesheet" href="/s3assets/css/vendor/bootstrap/custom-buttons.css">
</head>
<body class="zingtree">
<div class="widewrapper main">
<div class="container">
<div class="row" id="title_row">
<div class="col-md-12">
<div align="center">
<h2 id="title"></h2>
<p>&nbsp;</p>
</div>
</div>
</div>
<div id="nodes" class=" preview-all">
<div id="panelnode0" style="display:none;">
<div class="row">
<div class="col-md-12 col-sm-12">
<div class="node-header"></div>
<div class="panel panel-primary panels-node">
<div class="panel-heading panels-node-title">
<h3 class="panel-title"><span id="node-title">Node Title</span></h3>
</div>
<div class="panel-body panels-node-content">
<span id="node-content">Node Content</span>
<span class="zt-confirmation" id="node-confirmation"><br>Confirmation</span>
</div>
<ul id="qa-area" class="list-group panels-node-question">
<div id="question_area">
<li class="list-group-item list-group-item-question">
<h4><i class="fa fa-question-circle"></i> <span id="node-question">Question</span></h4>
</li>
</div>
<div class="answers"></div>
</ul>
</div>
</div>
</div>
</div>
<div id="buttonnode0" style="display:none;">
<div class="row">
<div class="col-md-12">
<div class="button-node">
<div class="row button-node-title">
<div class="col-md-12 col-sm-12">
<h3><strong><span id="node-title">Node Title</span></strong></h3>
</div>
</div>
<div class="row button-node-content">
<div class="col-md-12 col-sm-12">
<div class="node-header"></div>
<span id="node-content">Node Content</span>
<br>
<span class="zt-confirmation" id="node-confirmation"><br>Confirmation</span>
</div>
</div>
<div id="qa-area" class="well button-node-question">
<div id="question_area">
<div class="row">
<div class="col-md-12">
<h3 class="node-question-text"><span id="node-question">Question</span><br><br></h3>
</div>
</div>
</div>
<div class="row" align="center">
<div class="answers"></div>
</div>
</div>
</div>

</div>
</div>
</div>
</div>
<div id="emails">
<div id="panelemail0" style="display:none;">
<div class="row">
<div class="col-md-12 col-sm-12">
<div class="panel panel-primary">
<div class="panel-heading">
<h3 class="panel-title"><span id="node-title">Email Node Title</span></h3>
</div>
<div class="panel-body">
<form action="https://uploads.zingtree.com" method="post" class="form-horizontal" role="form" name="upload-zt-panel-email-attachment_url" id="upload-zt-panel-email-attachment_url" enctype="multipart/form-data"><input type="hidden" name="AWSAccessKeyId" id="AWSAccessKeyId" value="AKIAS32G7I2BK5EG23ZY" />
<input type="hidden" name="key" id="key" value="docs/433293119-${filename}" />
<input type="hidden" name="acl" id="acl" value="public-read" />
<input type="hidden" name="policy" id="policy" value="eyJleHBpcmF0aW9uIjoiMjAyMS0wNC0wMlQwODo1MDozNVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJ1cGxvYWRzLnppbmd0cmVlLmNvbSJ9LHsiYWNsIjoicHVibGljLXJlYWQifSx7InN1Y2Nlc3NfYWN0aW9uX3N0YXR1cyI6IjIwMSJ9LFsic3RhcnRzLXdpdGgiLCIka2V5IiwiZG9jcy80MzMyOTMxMTktIl0sWyJzdGFydHMtd2l0aCIsIiRDb250ZW50LVR5cGUiLCIiXSxbInN0YXJ0cy13aXRoIiwiJENvbnRlbnQtRGlzcG9zaXRpb24iLCIiXSxbImNvbnRlbnQtbGVuZ3RoLXJhbmdlIiwwLDQxOTQzMDQwXV19" />
<input type="hidden" name="signature" id="signature" value="mlRS2sGnLOe5BrSAuV/mrE7eqtI=" />
<input type="hidden" name="success_action_status" id="success_action_status" value="201" />
<input type="hidden" name="Content-Type" id="Content-Type" value="application/octet-stream" />
<input type="hidden" name="Content-Disposition" id="Content-Disposition" value="attachment; filename=" />
<label class="btn btn-sm btn-info pull-right " for="file-zt-panel-email-attachment_url"><input type="file" name="file" id="file-zt-panel-email-attachment_url" style="display:none;" onchange="on_upload_submit('zt-panel-email', 'attachment_url', 0) ;"><span class="attachment-label" id="filelabel-zt-panel-email-attachment_url"><i class="fa fa-paperclip" aria-hidden="true"></i> Add Attachment</span></label></form><br>
<br>
<form name="zt-panel-email" id="zt-panel-email" role="form" onsubmit="email_form_submit('zt-panel-email'); return(false) ;">
<input type="hidden" name="attachment_url" id="attachment_url" value="">
<div class="form-group">
<label for="email">Your Email Address:</label>
<input type="email" name="email" class="form-control ztemail-email" id="email" placeholder="Enter email" value="" required>
</div>
<div class="form-group">
<label for="name">Your Name</label>
<input type="text" name="name" class="form-control ztemail-name" id="name" placeholder="first + last name">
</div>
<div class="form-group">
<label for="subject">Subject:</label>
<input type="text" name="subject" class="form-control" id="subject" placeholder="Subject" value="Subject">
</div>

<div class="form-group">
<label for="message">Your Message</label>
<textarea class="form-control" rows="10" name="message" id="message" placeholder="Enter your message here">Your Message</textarea>
</div>
<button type="submit" class="btn btn-primary btn-lg"><span id="email-form-send-message-text">Send Message</span></button>
</form>
<br>
</div>
</div>
</div>
</div>
</div>
<div id="email-auto" style="display:none;">
<div class="row">
<div class="col-md-12">
</div>
</div>
</div>
<div id="buttonemail0" style="display:none;">
<div class="row">
<div class="col-md-12">
<br>
<h3><span id="node-title">Node Title</span></h3>
<form action="https://uploads.zingtree.com" method="post" class="form-horizontal" role="form" name="upload-zt-button-email-attachment_url" id="upload-zt-button-email-attachment_url" enctype="multipart/form-data"><input type="hidden" name="AWSAccessKeyId" id="AWSAccessKeyId" value="AKIAS32G7I2BK5EG23ZY" />
<input type="hidden" name="key" id="key" value="docs/433293119-${filename}" />
<input type="hidden" name="acl" id="acl" value="public-read" />
<input type="hidden" name="policy" id="policy" value="eyJleHBpcmF0aW9uIjoiMjAyMS0wNC0wMlQwODo1MDozNVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJ1cGxvYWRzLnppbmd0cmVlLmNvbSJ9LHsiYWNsIjoicHVibGljLXJlYWQifSx7InN1Y2Nlc3NfYWN0aW9uX3N0YXR1cyI6IjIwMSJ9LFsic3RhcnRzLXdpdGgiLCIka2V5IiwiZG9jcy80MzMyOTMxMTktIl0sWyJzdGFydHMtd2l0aCIsIiRDb250ZW50LVR5cGUiLCIiXSxbInN0YXJ0cy13aXRoIiwiJENvbnRlbnQtRGlzcG9zaXRpb24iLCIiXSxbImNvbnRlbnQtbGVuZ3RoLXJhbmdlIiwwLDQxOTQzMDQwXV19" />
<input type="hidden" name="signature" id="signature" value="mlRS2sGnLOe5BrSAuV/mrE7eqtI=" />
<input type="hidden" name="success_action_status" id="success_action_status" value="201" />
<input type="hidden" name="Content-Type" id="Content-Type" value="application/octet-stream" />
<input type="hidden" name="Content-Disposition" id="Content-Disposition" value="attachment; filename=" />
<label class="btn btn-sm btn-info pull-right " for="file-zt-button-email-attachment_url"><input type="file" name="file" id="file-zt-button-email-attachment_url" style="display:none;" onchange="on_upload_submit('zt-button-email', 'attachment_url', 0) ;"><span class="attachment-label" id="filelabel-zt-button-email-attachment_url"><i class="fa fa-paperclip" aria-hidden="true"></i> Add Attachment</span></label></form><br>
<br>
<form name="zt-button-email" id="zt-button-email" role="form" onsubmit="email_form_submit('zt-button-email') ;  return(false) ;">
<input type="hidden" name="attachment_url" id="attachment_url" value="">
<div class="form-group">
<label for="email">Your Email Address:</label>
<input type="email" name="email" class="form-control ztemail-email" id="email" placeholder="Enter email" value="" required>
</div>
<div class="form-group">
<label for="name">Your Name:</label>
 <input type="text" name="name" class="form-control ztemail-name" id="name" placeholder="first + last name">
</div>
<div class="form-group">
<label for="subject">Subject:</label>
<input type="text" name="subject" class="form-control" id="subject" placeholder="Subject" value="Subject">
</div>
<div class="form-group">
<label for="message">Your Message:</label>
<textarea class="form-control" rows="10" name="message" id="message" placeholder="Enter your message here">Your Message</textarea>
</div>
<button type="submit" class="btn btn-primary btn-lg"><span id="email-form-send-message-text">Send Message</span></button>
</form>
<br>
<br>
</div>
</div>
</div>
</div>
<div id="node1002" style="display:none;">
<div class="row">
<div class="col-sm-12">
<h3>Search results for "<span id="searchterm"></span>":</h3>
<ul>
<span id="searchresults">&nbsp;</span>
</ul>
</div>
</div>
</div>
<div id="node1004" style="display:none;">
<div class="row">
<div class="col-sm-12">
<h3>Search results for "<span id="searchterm"></span>":</h3>
<ul>
<span id="searchresults">&nbsp;</span>
</ul>
</div>
</div>
</div>
<div id="link-wait" style="display:none;">
<div class="row">
<div class="col-md-12">
<h3 align="center"><i class="text-cog fa fa-cog fa-spin fa-3x fa-fw" id="please-wait-cog"></i>&nbsp;&nbsp;Please wait...</h3>
</div>
</div>
</div>
<div id="pdf-wait" style="display:none;">
<div class="row">
<div class="col-md-12">
<h3 align="center"><i class="text-info fa fa-spinner fa-spin fa-3x fa-fw" id="please-wait-pdf"></i>&nbsp;&nbsp;Creating Document file. Please wait...</h3>
</div>
</div>
</div>
<div id="process-step-end" style="display:none;">
<div class="row">
<div class="col-md-12">
<p>Thanks! You are done with your parts of the process for now, and this task is <strong>released</strong>.</p>
<p>The next step will be taken by a person in this group: <span id="process-group-next"></span></p>
<p class="text-center"><br><a href="/tasks" class="btn btn-primary btn-lg">Return to Tasks</a>
</div>
</div>
</div>
<div id="task-completed" style="display:none;">
<div class="row">
<div class="col-md-12">
<p class="text-center"><br><a href="/tasks" class="btn btn-primary btn-lg">Task Complete - Return to Tasks</a>
</div>
</div>
</div>
<script>

// set to true if this script may be called upon to do an escalation
var escalation_pending = false ;

// set to true if we need to show an alert message after escalating in an open script
var show_escalation_alert = false ;

// set the initial escalation timer for this session
var escalate_in ;
set_escalation(0) ;


// set the escalation countdown timer, and flag for whether we need to escalate here if script is open
function set_escalation (seconds)
{
  
	
	// immediate escalation if value is 999999
	if (seconds == 999999*60)
	{
		show_escalation_alert = false ;		
		escalate_in = -99 ;
		escalation_pending = true ;
		
	}
	else
	{
	
		escalate_in = seconds ;
		escalation_pending = (escalate_in > 0) ;
	}
	
    
}


// padding function for seconds display
function pad(num, size) {
    var s = "000000000" + num;
    return s.substr(s.length-size);
}


// update escalation timer display every second

function show_escalation()
{
    
// show alert if we automatically escalated from here
    if (show_escalation_alert)
    {
        show_escalation_alert = false ;
        alert ("Please note: This task has been automatically escalated.") ;
        return ;
    }
    
    // countdown timer expired, or is inactive
    // if it was active, then do the escalation from the open script before the cron job gets to it
    
    if (escalate_in <= 0)
    {
        $("#escalation-summary").hide() ;
        
        if (escalation_pending)
        {
			if (escalate_in > -20)
				show_escalation_alert = true ;	// hide alerts if it was an immediate escalate request (set to -99)
			
            escalate_in = 0 ;
            escalation_pending = false ;
            
            if (trees[this_tree_id].nodes[this_node_id].continuation_node_id != 0)
            {
                do_button_click (trees[this_tree_id].nodes[this_node_id].continuation_node_id, this_node_id, '*PB*Escalate', 0, '') ;
            }
            else   
			{
				show_escalation_alert = false ;
                alert ("No escalation occurred since no escalation node was set up.") ;   
			}
            
        }
        return ;   
    }
    
    $("#escalation-summary").show() ;
    
    var days = Math.floor(escalate_in / (60 * 60 * 24));
    var hours = Math.floor((escalate_in % (60 * 60 * 24)) / (60 * 60));
    var minutes = Math.floor((escalate_in % (60 * 60)) /  60);
    var seconds = Math.floor(escalate_in % (60));

    escalate_in -= 1 ;  // decrement counter
    
    var escalate_summary = '' ;
    
    if (days > 0)
    {
        // round for better information
        if (hours > 12)
            ++days ;
            
        escalate_summary += days + " day" ;
        if (days != 1)
            escalate_summary += 's ' ;
        else
            escalate_summary += ' ' ;
    }
    
    else
    {
        if (hours > 0)
        {
            escalate_summary += hours + " hour" ;
            if (hours != 1)
                escalate_summary += 's ' ;
            else
                escalate_summary += ' ' ;
            
        }
        
        escalate_summary += minutes + " minute" ;
        if (minutes != 1)
            escalate_summary += 's ' ;
        else
            escalate_summary += ' ' ;
        
        
    // if under 1 hour, show just minutes:seconds
    
        if (hours == 0)
            escalate_summary = minutes + ':' + pad(seconds,2) ;
    
    }
    
    $("#escalate-in").text(escalate_summary) ;    
     
}


// update escalation countdown
var xx = setInterval(function() 
{
    show_escalation() ; 
    
}, 1000) ;


// also show immediately when document is ready
$(function() {
    show_escalation() ; 
});

</script>
<div class="row persistent-buttons">
<div class="col-xs-9 col-md-11">
<br>
<a href="#" id="back_button" class="btn btn-default hidden-print" onclick="go_back(); return false;" data-toggle="tooltip" data-placement="top" title="Go back one step"><i class="fa fa-arrow-left"></i> Back</a>
<span id="escalation-summary" style="display:none;" class="text-danger"><br><small>Escalating in <span id="escalate-in"></span></small></span>
</div>
<div class="col-xs-3 col-md-1">
<div align="right">
<br>

<a id="session-notes-button" class="btn btn-success hidden-print" data-toggle="tooltip" data-placement="bottom" title="Add notes to this session" onclick="get_notes('dlg'); $('#session-notes-form').modal('show') ;"><i class="fa fa-pencil-square"></i> </a>
<span class="hidden-print">
<a href="https://zingtree.com" target="_blank"><img src="https://zingtree.com/img/transparent.png" width="24" height="24" align="absmiddle" alt="Decision Tree built with Zingtree" /></a>
</span>
<br> <span data-iframe-height>&nbsp;</span>
</div>
</div>
</div>
</div>
</div>
<script>

    // JavaScript functions for /deploy/tree.php

    // ***** initialize ********

    // initialize vars (pass from PHP to JS)

    var debug_mode = false;
    
    var tracking_url = "/api/track-async.php";
    var app_message_url = "/apps/send-message.php";
    var tree_find_url = "/api/rest/zingtree.php";
    var agent_alert_url = "/deploy/get-agent-alert.php";
    var email_autosend_url = "/deploy/auto-send-email.php";
    var task_checkin_url = "/api/checkin-task.php";
    var task_complete_url = "/api/complete-task.php";
    var pdf_generate_url = "/pdf/generate.php";
    var html_generate_url = "/htmlfile/generate.php";
    var advanced_logic_node_evaluator_url = "/api/advanced-logic-evaluator.php";
    var advanced_docnode_logic_node_evaluator_url = "/api/advanced-docnode-logic-evaluator.php";

    var agent_mode = 0;
    var agent_email = '';
    var agent_name = '';

    var bot_mode = 0;

    // for process tree special handling
    var is_process = 0;
    var agent_tags = '';

    var show_history_data_entered = 1;

    var view_as_agent = 2;
    var hide_end_user_only = 0 ;
    var uid = '1617349835';
    var source = 'Zingtree+Hosted';      // get the source/agent
    var zt_style = 'buttons';    // get the style
    var tree_id = '842095957';
    var start_node = 1;
    var root_node = 1;
    var nostate = 0;
    var disable_scroll = 0;
    var scroll_parent_to_top = 1;
    var transition = 'none';   // none / fade / slide
    var transition_duration = 500;    // duration of transition
    var auth_token = '';    // authorization token for webhook calls
    var responsive_videos = 1;
    var keep_vars_on_back = 0;   // == 1 to not erase vars when back button, history back, or restart
    var integration = '';   // are we doing a specific integration? This has it's name, and we can do special code as needed
    var merge_vars_not_fixed = 0;
    var disable_autocomplete = 0;
    var live_mode_active = false;


    // how this tree is called
    var uri = "https://zingtree.com%2Fdeploy%2Ftree.php%3Ftree_id%3D842095957%26style%3Dbuttons%26z%3Dwordpress%26disable_scroll%3D0";

    var ignore_hash_change = 0;        // == 1 to ignore the change of hash to trigger back event from back button click

    var click_num = 0;                 // increment on each click -- used to keep async events in order for session reporting
    var showing_answers_only = false;  // history display - answers-only view state

    var address_map;

    var persistent_button_return_node = 0;     // if nonzero, tree node launches return to this node. Used for persistent button tree node returns

    var escalation_click = 0;	// running remote clicks? Flag it here. Used to disable required fields

    var run_webhook = 0;	// == 1 to rerun the webhook on a the currnt node after the tree loads (reloads vars on a pause & resume)

    // the master tree is always the first tree
    // used by subtree handler

        var master_tree_id = tree_id;
    
    // current tree and node
    var this_tree_id = tree_id;
    var this_node_id = start_node;

    // globals for delayed tracking call
    // used for launch action in load_tree
    var last_node_id;
    var last_value;
    var last_button_text;

        var show_all = 0;
    
        var view_all = 0;
    

    // marker for uniquely identifying nodes

    var idnode;
    var idnode0;     // same as idnode, without the #


    // get the merge variables and values

    // get merge variables and values
    // uses this JQuery extender for query string

    $.extend({

        getUrlVars: function () {
            var vars = [];
            var hash;
            var i;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for (i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar: function (name) {
            return $.getUrlVars()[name];
        },

        getContainerVars: function () {
            var vars = [];
            var hash;
            var i;
            var hashes = document.referrer.slice(document.referrer.indexOf('?') + 1).split('&');
            for (i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },

        getContainerVar: function (name) {
            return $.getContainerVars()[name];
        },

        // returns an array of merge varables that start with zv_

        getContainerMergeVars: function () {
            var vars = [];
            var hash;
            var i;
            var hashes = document.referrer.slice(document.referrer.indexOf('?') + 1).split('&');
            for (i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                if (hash[0].indexOf('zv_') == 0) {
                    var v = hash[0].substr(3);  // remove zv_ part
                    vars[v] = hash[1];

                }
            }
            return vars;
        }


    });


    // get merge variables

    // var zt_variables = $.getUrlVar('variables');

    var zt_variables = '';
    var zt_values = '';

    var zt_container_session_id;   // this will be the session ID if passed from the container

    
    if ((typeof zt_variables === "undefined") || (typeof zt_values === "undefined") || (zt_variables == '')) {
        zt_vars = new Array();
        zt_vals = new Array();

        zt_variables = '';
        zt_values = '';

    } else {
        // make special characters passed along in values part work
        zt_values = zt_values.replace('&amp;amp;', '&');
        zt_values = zt_values.replace(/&amp;/g, "&");


        // poor man's URIDecode for | characters

        zt_values = zt_values.replace(/%7C/g, "|");
        zt_variables = zt_variables.replace(/%7C/g, "|");

// replace non-alpha characters (but not | delimiter) with underscores in variables.  Prevents weird variable names that break javascript

        zt_variables = zt_variables.replace(/\?/g, "");    // remove trailing ? at end
        zt_variables = zt_variables.replace(/[^0-9a-zA-Z|]/g, "_");

// make arrays or variables and values
        var zt_vars = zt_variables.split("|"); // array of variables
        var zt_vals = zt_values.split("|");    // array of values
    }


    var trees = [];     // all loaded trees

    // history stacks
    var tree_launch_history = [];
    var tree_launch_return_node_history = [];

    var tree_history = [];
    var button_history = [];
    var button_text_history = [];
    var tag_history = [];
    var form_data_history = [];


    // initialize the form data

    var form_data = {};
    init_form_data();
    var form_changes = {};


    // make the session ID: either use incoming session ID, or create a new one if not yet set

    var session_id = '';
    if (typeof zt_container_session_id !== "undefined")
        session_id = zt_container_session_id;

    // new session? create a session ID, and load the first node in the tree

    if (session_id == '') {
        session_id = generateUUID();
        load_tree(this_tree_id, "init", 0);
        load_state(this_tree_id);
    }


// load saved state from this session
// (except if nostate flag is set. )

    else {
        if (nostate == 0)
            load_state(this_tree_id);
        else {

            // init history stacks
            tree_history.push(tree_id);
            button_history.push(this_node_id);
            button_text_history.push('Start');

            load_tree(this_tree_id, "init", start_node);

        }

    }

    // set defaults on any unset data entry fields (if tree option set)
    init_data_entry_fields();


    log("session ID= " + session_id);

    // load the main tree


    // ******** functions ****************************


    var zingtreeEvents = {};

    function emitEvent(event, payload, result) {
        if (debug_mode) console.log("emitEvent: event=" + event + " payload=", payload);
        zingtreeEvents = typeof zingtreeEvents === 'undefined' ? {} : zingtreeEvents;
        (zingtreeEvents[event] = zingtreeEvents[event] || []).forEach(function(handler) {
            result = handler(payload, result);
        });
        return result;
    }

    function whenEvent(event, handler) {
        if (debug_mode) console.log("whenEvent: event=" + event);
        zingtreeEvents = typeof zingtreeEvents === 'undefined' ? {} : zingtreeEvents;
        zingtreeEvents[event] = zingtreeEvents[event] || [];
        if (zingtreeEvents[event].indexOf(handler) < 0) zingtreeEvents[event].push(handler);
    }

    function emitExternalEvent(event, payload) {
        var e = {
            event: event,
            zingtree_session: session_id,
            data: payload
        }
        if (debug_mode) console.log("emitExternalEvent: Sending: ", e);
        parent.postMessage(e, "*");
    }

    function assignSessionVars(vars, noEvent) {
        for (k in vars) {
            assignSessionVar(k, vars[k], noEvent);
        }
        return vars;
    }

    function assignSessionVar(k, v, noEvent) {
        form_data[k] = v;
        if (! noEvent) {
            emitEvent('sessionVariableChange', {
                name: k,
                value: v
            });
        }
        return v;
    }

    function signalResolution(r) {
        if (r != '?') emitEvent("resolutionChanged", r);
    }

    // fixes issue where DecodeURI barfs on a string with a % in it (not URLEncoded)	<br>

    function decodeURIComponentSafe(s) {
        if (!s) {
            return s;
        }
        return decodeURIComponent(s.replace(/%(?![0-9][0-9a-fA-F]+)/g, '%25'));
    }

    function GetDatePickerRegion(locale) {

        // Try to get region directly (with the same name)
        var region = $.datepicker.regional[locale];
        if (region != undefined)
            return region;

        // Fallback when region specific (e.g. "de-DE" to "de")
        if (locale.length > 2) {
            region = $.datepicker.regional[locale.substring(0, 2)];
            if (region != undefined)
                return region;
        }

        // Return default region
        region = $.datepicker.regional[""];
        return region;
    }

    // returns true if a tag in string list tags1 is also in tags2
    // thanks to: https://stackoverflow.com/questions/16312528/check-if-an-array-contains-any-element-of-another-array-in-javascript

    function do_tags_match(tags1, tags2) {
        var t1 = tags1.replace(/,/g, " ");    // tags are delimited by spaces or commas
        t1 = t1.split(" ");

        var t2 = tags2.replace(/,/g, " ");
        t2 = t2.split(" ");

        return t1.some(function (v) {
            return t2.indexOf(v) >= 0;
        });
    }


    // keep tree in view - respecting disable_scroll

    function fix_scroll() {

        
        // scroll the window to the top if set

        if (disable_scroll == 0) {
            if ('parentIFrame' in window) {
                if (scroll_parent_to_top)
                    parentIFrame.scrollTo(0, 0);
                else
                    parentIFrame.scrollToOffset(0, 0);
            } else
                window.scrollTo(0, 0);
        }

            }


    // initialize form data upon first load, or after a restart

    function init_form_data() {
        form_data = new Object();

        
        
        
        
        
        
        
        // replace '+' in variables, values with space characters
        // also decode things like %20 and other encoded things

        $.each(zt_vals, function (i, zt_val) {
            if (typeof zt_vals[i] !== "number") {

                // convert strings to numbers if they are numeric
                if ($.isNumeric(zt_vals[i]))
                    zt_vals[i] = Number(zt_vals[i]);
                else {
                    zt_vals[i] = decodeURIComponentSafe(zt_vals[i].replace(/\+/g, " "));
                    zt_vals[i] = zt_vals[i].replace("``", "|");	// hack to convert `` to | in case | is required in a variable
                }


            }
        });


        
        // do the same for variable names, and import these into form_data

        $.each(zt_vars, function (i, zt_var) {

//        zt_vars[i] = decodeURI(zt_vars[i].replace(/\+/g, " ")) ;
            zt_vars[i] = decodeURIComponentSafe(zt_vars[i].replace(/\+/g, " "));
            if (typeof zt_vals[i] !== "undefined")
                form_data[zt_vars[i]] = zt_vals[i];
        });


    }


    // initialize form variables in this tree (if not otherwise defined)

    function init_data_entry_fields() {

        

    }

    // validate an email address
    // from http://stackoverflow.com/questions/2507030/email-validation-using-jquery

    function validateEmail($email) {

//    if ($email == '')
//        return false ;

        var emailReg = /^([\w-\.]+@([\w-]+\.)+[\w-]{2,4})?$/;
        return emailReg.test($email);
    }


    // custom validation
    // make sure the text fits the pattern in the regex

    function validateCustom(text, regex) {
        try {
            var test_exp = new RegExp(regex);
            return (test_exp.test(text));
        }

// handles regex errors gracefully
        catch (err) {
            alert(err);
            return (false);
        }
    }

    // validate a date

    
    function validateDate($date) {
                return (true);
            }


    // hides an element according to the current transition

    function do_transition(hide_elt, show_elt) {

        // fade. Hide part has already fired

        if (transition == 'fade') {
            $(show_elt).fadeIn(transition_duration);
        } else if (transition == 'slide') {
            $(hide_elt).slideUp(transition_duration);
            $(show_elt).slideDown(transition_duration);
        } else {
            $(hide_elt).hide();
            $(show_elt).show();

        }

    }


    // do a fade
    // this needs to happen at the end of the button click process

    function do_fade(hide_elt, show_elt) {

        // wait until hide completes, then fade In
        $(hide_elt).fadeOut(transition_duration, function () {
            $(show_elt).fadeIn(transition_duration);
        });
    }


    function hide_effect(elt) {
        if (transition == 'fade')
            $(elt).fadeOut(transition_duration);

        else if (transition == 'slide')
            $(elt).slideUp(transition_duration);


        else
            $(elt).hide();

    }


    // shows an element according to the current transition

    function show_effect(elt) {
        if (transition == 'fade')
            $(elt).fadeIn(transition_duration);


        else if (transition == 'slide')
            $(elt).slideDown(transition_duration);

        else
            $(elt).show();


    }


    // return the scoring variable name
    // defaults to 'score" if score_var attribute not set

    function get_score_var(elt) {
        var score_var;

        // list box selections
        if (typeof $('option:selected', elt).attr('score_var') !== "undefined")
            score_var = ($('option:selected', elt).attr('score_var'));

        // checkboxes / radio buttons
        else if (typeof $(elt).attr('score_var') !== "undefined")
            score_var = ($(elt).attr('score_var'));

        // set default "score" variable if score_var attribute not set
        else
            score_var = "score";

        return (score_var);
    }


    // makes a single string from form data, like this:
    // key1|value1|key2|value2| ...

    function make_form_data_string(form_data) {
        form_data_string = '';
        $.each(form_data, function (key, value) {

            // no pipe characters in catenated string, use HTML equivalent instead

            k = key.replace(/\|/g, "!");

            if (typeof value === "string")
                v = value.replace(/\|/g, "!");
            else
                v = value;

            if (k != '')
                form_data_string += k + "|" + v + "|";

        });

        return (form_data_string);

    }

    // search all button
    // pass along parameters, including current node # for tracking
    function do_search_all(qs) {

        window.location.href = "/host-trees.php?" + qs + "&from_tree_id=" + this_tree_id + "&master_tree_id=" + master_tree_id + "&from_node_id=" + this_node_id;

    }

    // console.log was killing IE9  , so we only log when &debug=1 is appended to the URL

    function log(item) {
            }


    // make a unique session ID
    // uuid used for unique session code

    function generateUUID() {
        var d = new Date().getTime();
        var uuid = 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (d + Math.random() * 16) % 16 | 0;
            d = Math.floor(d / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        return uuid;
    };


    // update the history or breadcrumb display (if present)

    function update_history_display() {


// handle special for task manager

        if (is_process) {
            if (typeof trees[this_tree_id].nodes !== 'undefined') {

                // show the progress details of the task

                var request = $.ajax({
                    url: "/api/get-task-progress.php",
                    method: "POST",
                    data: {session_id: session_id, tags: agent_tags},
                    async: true,
                    dataType: "html"
                });


                request.done(function (data) {
                    $("#zt_history").html(data);

                });


                // get the data gathered
                var request = $.ajax({
                    url: "/api/get-task-data.php",
                    method: "POST",
                    data: {session_id: session_id},
                    async: true,
                    dataType: "html"
                });


                request.done(function (data) {
                    $("#zt_task_data").html(data);
                });


            }

            return;

        }

        // ignore these fields if adding data entry fields to history display

        var ignore_data_fields = [
            'session_history',
            'data_entered',
            'email_send_status',

            'tree_name',
            'tree_id',
            'last_tree_name',
            'last_tree_id',
            'container_url',
            'zt_browser_language',
            'zt_browser',
            'zt_country',
            'zt_regionName',
            'zt_city',
            'zt_zip',
            'zt_ip',
            'zt_tz',
            'zt_tz_encoded',
            'zt_isp',
            'zt_org'
            /*
// Zendesk data fields
		'zd_ticket_id',
		'requester_name',
		'requester_email',
		'zd_subject',
		'zd_priority',
		'zd_type',
		'zd_status',
		'zendesk_tags',
		'agent_tags',
		'agent',
		'agent_first_name',
		'Zingtree_Session_ID',
		'userdata'
*/

        ];

        var history_count = 0; // keep a counter for history items

// build the html for the history display

        var h = "";
        var i = 0;
        var tree_id;

        var session_history_current = '';

        var len = button_text_history.length;
        for (i = 1; i < len; i++) {
            tree_id = tree_history[i]; // make sure we're using the proper tree

            // don't show scoring branch or link node in history display

            var btext = button_text_history[i];


            if (-1 == btext.indexOf("*SB*")) {
                steps = len - i;

                // history back button

                ++history_count;

                h += '<a class="more" onclick="history_back(' + steps + ', false);" data-toggle="tooltip" data-placement="top" title="Go back to this step"><i class="fa fa-arrow-circle-o-left zt-history-question"></i></a>&nbsp;';

                session_history_current += btext;

                // Q&A text
                h += btext;

                // show incremental data entered (if option set)
                if (show_history_data_entered == 1) {
                    // just gather data entered from current step that wasn't in history for previous step
                    var new_data = '';
                    var last_fd = form_data_history[i - 1];

                    if (i == len - 1) {
                        fd = form_data;	// use current form data if showing last step
                    } else {
                        fd = form_data_history [i];
                    }

                    if (typeof last_fd === 'undefined')
                        last_fd = [];

                    // add any new data fields, ignore some stock fields and merge variables

                    $.each(fd, function (key, value) {

                        if ((typeof last_fd[key] === 'undefined') && (value != '') && (-1 == $.inArray(key, ignore_data_fields)) && (-1 == $.inArray(key, zt_vars)))
                            new_data += key + ': ' + value + '<br>';
                    });

                    // add new data entered to history display
                    if (new_data != '')
                        h += '<span class="zt-history-data" style="display:none;">' + new_data + '<br></span>';

                }
            }
        }

        if (h == "") {
            h = "No History";
            session_history_current = h;
        }

        // insert the history into the DOM

        $("#zt_history").html(h);
        $(".zt-all-clicks").html(session_history_current);

        // also send history to container, in case it wants to do something with this

        parent.postMessage("HISTORY: " + h, '*');


// update the breadcrumbs display

        var b = '<ol class="breadcrumb">';
        len = button_history.length;
        for (i = 0; i < len; i++) {

            steps = len - i - 1;

            // get the breadcrumb text from the history

            tree_id = tree_history[i]; // make sure we're using the proper tree
            var breadcrumb_text;

            /*
        if (button_history[i] == 1002)
            breadcrumb_text = "Search" ;
        else if (button_history[i] == 1003)
            breadcrumb_text = "Tree-Search" ;
        else if (button_history[i] == 1004)
            breadcrumb_text = "Tree-Search" ;
*/
            // search or taglist nodes use the button text history

            if (button_history[i] >= 1000) {
                breadcrumb_text = button_text_history[i];
            } else {
                // tree may still be loading, so this prevents an error
                if (
                    (typeof trees[tree_id] === "undefined") ||
                    (typeof trees[tree_id].nodes === "undefined") ||
                    (typeof trees[tree_id].nodes[button_history[i]] === "undefined")
                )
                    breadcrumb_text = "Loading...";
                else
                    breadcrumb_text = trees[tree_id].nodes[button_history[i]].page_title_plain;
            }

            // breadcrumb display + back link
            if (steps > 0) {
                // don't show scoring branch in breadcrumb display
                if ((button_text_history.length > i + 1) && (-1 == button_text_history[i + 1].indexOf("*SB*"))) {
                    b += '<li><a class="more" onclick="history_back(' + steps + ', false);" data-toggle="tooltip" data-placement="top" title="Go back to this step">' + breadcrumb_text + '</a></li>';
                }
            }

            // current item - no link
            else
                b += '<li>' + breadcrumb_text + '</li>';

        }

        b += '</ol>';


        // insert the breadcrumbs display into the DOM

        $("#zt_breadcrumbs").html(b);


        parent.postMessage("BREADCRUMBS: " + b, '*');


// update the history count display
        $("#zt_history_item_count").text(history_count);

// add form_data to history panel
// ignore "score"

        var form_data_display = '';
        $.each(form_data, function (key, value) {
            if ((key != '') && (key != 'score')) {
                // don't include merge variables (these are Zendesk custom fields)
                if (zt_vars.indexOf(key) == -1)
                    form_data_display += '<strong>' + key + ': </strong> ' + value + '<br>';
            }

        });


        // show control, stuff form data in place

        if (form_data_display != '') {
            $("#zt-form-data-display").html(form_data_display);

            $('.zt-hide-form-data').show();
            $('.zt-show-form-data').hide();
        }


        // hide form data controls if not present

        else {
            $('.zt-show-form-data').hide();
            $('.zt-hide-form-data').hide();
        }


// keep answers-only text in history in sync with state

        if (showing_answers_only)
            $(".zt-history-question").hide();
        else
            $(".zt-history-question").show();


    }


    // handler for persistent buttons
    // these must be part of the main tree

    function do_persistent_button_click(show, hide, button_text, value) {
        var last_tree_id = this_tree_id;   // save current tree

// permanent buttons refer to master tree, so switch back to master

        this_tree_id = master_tree_id;

        // hide the previous node in a subtree if a persistent button is pressed in the new tree
        if ((transition == "fade") && (last_tree_id != this_tree_id)) {
            $('#node-' + last_tree_id + '-' + hide).fadeOut(transition_duration, function () {

            });


        }

// do the button click
// set a global to the return node in case we're launching a tree node with a return in the subtree
// this also makes do_button_click not submit form variables

        persistent_button_return_node = hide;
        do_button_click(show, hide, button_text, value, '');
        persistent_button_return_node = 0;


// restore current tree if it's a link node

        if (trees[master_tree_id].nodes[show].type == "Link")
            this_tree_id = last_tree_id;

    }


    // generate a PDF and start the download

    function download_pdf() {

        var url = "/pdf/generate.php?download=1&tree_id=" + this_tree_id + "&node_id=" + this_node_id + "&session_id=" + session_id;
        window.location.href = url;

    }

    // generate an HTML file and start the download

    function download_html() {

        var url = "/htmlfile/generate.php?download=1&tree_id=" + this_tree_id + "&node_id=" + this_node_id + "&session_id=" + session_id;
        window.location.href = url;

    }


    // simplified interface for image buttons, API, remote clicks

    function remote_button_click(node_id, button_text) {
        do_button_click(node_id, this_node_id, button_text, 0, '')
    }


    // show the selected node, and hide the current one
    // also saves the selected node in the history

    function do_button_click(show, hide, button_text, value, button_data) {

        ignore_hash_change = 1;

        var click_tree_id = this_tree_id;  // save tree from this click
        var resolution_state;
        var zd_button_tag = '';


        // stop videos or other embedded objects from playing when we go to a new node
        // if there is an iframe inside maybe embedded multimedia video/audio, we should reload so it stops playing
        // via https://stackoverflow.com/questions/15164942/stop-embedded-youtube-iframe

        var iframes = document.getElementsByTagName("iframe");
        if (iframes != null) {
            for (var i = 0; i < iframes.length; i++) {
                if (iframes[i].src != '')
                    iframes[i].src = iframes[i].src; // causes a reload so it stops playing, music, video, etc.
            }
        }


// if button text has '::' in it, then send everything after the :: as a tag to Zendesk
// ... and remove all before the ::

        parts = button_text.split('::');
        if (parts.length == 2) {
            zd_button_tag = parts[1];
            button_text = parts[0];
        }


        if (show == 0) {
            alert("Sorry: That button goes to a node that has not yet been created. Origin was Node #" + hide);
            return;
        }


// thumbnail overview mode: scroll to node instead of hiding it
// this needs a delay

        if (show_all == 1) {
            setTimeout(function () {
                var idnode = '#node-' + this_tree_id + '-';
//            var offset= $(idnode+this_node_id).offset().top ;

                var offset = $(idnode + show).offset().top;
                window.scrollTo(0, offset);
            }, 1000);

            return;
        }


// see if we have any "req" fields visible and empty, and if so highlight them and show an alert

        var show_validation_alert = 0;
        var alert_msg = '';

        var missing_required_field = false;
        var missing_required_email = false;
        var missing_required_radio_button = false;

        // don't do form validation on persistent button clicks or remote escalations

        if ((persistent_button_return_node == 0) && (escalation_click == 0)) {
            $(':input[req]:visible').each(function () {


                // find and highlight empty "req" fields
                if ($(this).val() == '') {

                    $(this).addClass("required-error");
                    missing_required_field = true;

                    if ($(this).attr('type') == 'email')    // we handle email types later
                        missing_required_email = true;

                }

                // unhighlight good fields
                else
                    $(this).removeClass("required-error");


                // see if we have a value for required radio buttons
                // highlight empty options if nothing selected

                if ($(this).attr('type') == 'radio') {
                    var radio_name = $(this).attr('name');

                    if (typeof $('input[name=' + radio_name + ']:checked').val() === 'undefined') {
                        $("label[for='" + radio_name + "']").addClass("required-error")
                        missing_required_radio_button = true;
                    } else
                        $("label[for='" + radio_name + "']").removeClass("required-error")


                }


            });


            // one alert message for multiple missing required fields

            if (missing_required_field)
                alert_msg += "\nPlease fill the highlighted fields.\n";

            if (missing_required_radio_button)
                alert_msg += "\nPlease select one of the highlighted options.\n";


            // validate custom fields

            $('.zt-data-custom:visible').each(function () {

                // see if required, or not blank
                if ((typeof $(this).attr("req") === "string") || ($(this).val() != '')) {
                    if (!validateCustom($(this).val(), $(this).attr("regex"))) {
                        $(this).addClass("required-error");
                        alert_msg += "\nInvalid entry (" + this.name + ").\n";
                    } else
                        $(this).removeClass("required-error");
                }
            });


            // check email types

            $(':input[type="email"]:visible').each(function () {

                if (!validateEmail($(this).val())) {
                    $(this).addClass("required-error");
                    alert_msg += "\nPlease make sure you have entered a valid email address.\n";
                } else {
                    if (!missing_required_email)
                        $(this).removeClass("required-error");
                }

            });


            // check date types

            $('.datepicker:visible').each(function () {

                if (!validateDate($(this).val())) {
                    $(this).addClass("required-error");
                    alert_msg += "\nInvalid date. Try using the calendar date picker.\n";
                } else
                    $(this).removeClass("required-error");

            });

        }


// show alert(s) if any validation failed
// return ensures we don't proceed to the next node
        if (alert_msg != '') {
            alert(alert_msg);
            return;

        }


// for fade effect, do the effect, then recall this function with a negative hide value
// negative hide value ensures we don't infinite loop


        if (hide < 0)
            hide = hide * -1;
        else {
            // do transitions for all except logic nodes
            if ((transition == 'fade') && (trees[this_tree_id].nodes[hide].type != "Scoring")) {

                if (hide < 1000) {
                    /*
                // wait until fadeOut completes, then restart the do_button_click call
                $('#node-'+this_tree_id+'-'+hide).fadeOut(transition_duration, function()
                {
                    do_button_click(show, -1 * hide, button_text, value, button_data)
                }) ;
*/

                    // wait until fadeOut completes, then restart the do_button_click call
                    $('#node-' + this_tree_id + '-' + hide).fadeOut({
                        duration: transition_duration,
                        always: function () {
                            do_button_click(show, -1 * hide, button_text, value, button_data);
                        }

                    });


                }

                // special nodes - element ID is different

                else {

                    // wait until fadeOut completes, then restart the do_button_click call
                    $('#node' + hide).fadeOut(transition_duration, function () {
                        do_button_click(show, -1 * hide, button_text, value, button_data)
                    });


                }


                return;

            }
        }




        

// make a copy-by-value of form_data and put it on the stack later
// this is the previous state before we modify things

        fd2 = jQuery.extend({}, form_data);

        if (persistent_button_return_node == 0) {

            // extract form fields from the DOM and save in form_data
            // only get form fields from node that showed (visible) before the click

            $("#node-" + this_tree_id + "-" + hide + " .zt-data").each(function (index) {
                if (($(this).attr('type') != 'radio') && ($(this).attr('type') != 'checkbox')) {

                    k = $(this).attr('name');
                    var v;

                    // clean up tabs and null variables

                    v = $(this).val();
                    if (v != null)
                        v = v.replace(/\t/g, ' ');
                    else
                        v = '';

                    form_data[k] = v;


                    // add to the score if a score= attribute is set
                    // if score_var is set as an attribute, use that as the scoring variable, otherwise use "score" as the scoring variable

                    if (typeof $('option:selected', this).attr('score') !== "undefined") {

                        score_var = get_score_var(this);

                        // init scoring var if not yet set
                        if (typeof form_data[score_var] === "undefined")
                            form_data[score_var] = 0;

                        // add to the total score for form score= elements
                        //               form_data[score_var] += Number($('option:selected', this).attr('score'));

                        var v = $('option:selected', this).attr('score');
                        if (($.isNumeric(v)) && ($.isNumeric(form_data[score_var])))
                            form_data[score_var] = Number(v) + Number(form_data[score_var]);
                        else
                            form_data[score_var] = v;


                    }
                }

            });


            // extract radio buttons special by just snagging values from selected form elements

            $('#node-' + this_tree_id + '-' + hide + ' input[type="radio"]:checked').each(function (index) {
                if ($(this).hasClass('zt-data')) {
                    form_data[$(this).attr('name')] = $(this).val();

                    // score in radio button variables
                    if (typeof $(this).attr('score') !== "undefined") {

                        score_var = get_score_var(this);

                        // init scoring var if not yet set
                        if (typeof form_data[score_var] === "undefined")
                            form_data[score_var] = 0;

                        // keep a running total if score var value is numeric
                        // otherwise just copy text
                        if ($.isNumeric($(this).attr('score')))
                            form_data[score_var] += Number($(this).attr('score'));
                        else
                            form_data[score_var] = $(this).attr('score');
                    }

                }

            });


            // extract checkboxes special by just snagging values from selected form elements

            // checked elements get their checked value
            // unchecked elements are set to zero

            $('#node-' + this_tree_id + '-' + hide + ' input[type="checkbox"]').each(function (index) {
                if ($(this).hasClass('zt-data')) {
                    var k;
                    var v;

                    k = $(this).attr('name');

                    // sf_ checkbox variables (for Salesforce) get true/false
                    if (k.indexOf("sf_") == 0) {
                        v = false;
                        if ($(this)[0].checked)
                            v = true;
                    }

                    // all other checkbox variables get 0/1
                    else {

                        v = 0;
                        if ($(this)[0].checked)
                            v = $(this).val();

                    }

                    form_data[k] = v;
                    //           form_data[$(this).attr('name')] = v;


                    // score in checkbox variables
                    if ((typeof $(this).attr('score') !== "undefined") && ($(this)[0].checked)) {

                        score_var = get_score_var(this);

                        // init scoring var if not yet set
                        if (typeof form_data[score_var] === "undefined")
                            form_data[score_var] = 0;

                        // keep a running total if score var value is numeric
                        // otherwise just copy text
                        if ($.isNumeric($(this).attr('score')))
                            form_data[score_var] += Number($(this).attr('score'));
                        else
                            form_data[score_var] = $(this).attr('score');

                    }
                }

            });


        }

        emitEvent('sessionUpdated');

// if it's not a link node, show the new node, hide the old one

        if (typeof trees[this_tree_id].nodes[show] === 'undefined') {
            alert("Node #" + show + " does not exist.");
            return;
        }

// let the parent window know we've changed the current node
// this also works for browser-back-host.js for enabling back button support in the window hosting the iframe

        if ((trees[this_tree_id].nodes[show].type != "Tree") && (trees[this_tree_id].nodes[show].email_send_now != 1)) {
            parent.postMessage("Node=" + show, "*");
            parent.postMessage("Tree=" + this_tree_id, "*");
            parent.postMessage("Treename=" + trees[this_tree_id].name, "*");
            emitEvent("nodeTransition", {
                treeId: this_tree_id,
                toNodeId: show
            });

            // pass form data up as an object, adding resolution_state
            parent.postMessage(jQuery.extend({
                resolution_state: trees[this_tree_id].nodes[show].resolution_state,
                zingtree_session: session_id
            }, form_data), "*");

        }


// set the new current node (unless it's a link)

        if (trees[this_tree_id].nodes[show].type != "Link") {
            this_node_id = show;
//        window.top.location.hash = this_node_id ;
        }

        var to_node_id = show; // save the to_node for tracking API


// save the previous tree ID in case we change trees

        var last_tree_id = this_tree_id;
        var last_question;

        var this_tag = trees[this_tree_id].nodes[show].tag;

        
// manage tags stack

        tag_history.push(this_tag);


// put the score variable and running total value into the form data object
// this uses the PREVIOUS node's score_var

        var score_var;
        var hide_tree;
        hide_tree = tree_history[tree_history.length - 1];  // tree from previous "hide" node

        if (tree_history.length == 0)
            score_var = "score";
        else if (hide < 1000)    // not a special node
            score_var = trees[hide_tree].nodes[hide].score_var;
        else
            score_var = "score";

        // no empty score vars
        if (score_var == '')
            score_var = "score";

        // make a list of button click (scoring) variables - each separated by a pipe
        // in no pipe, just uses one variable

        var button_data_list = [] ;
        var score_var_list = score_var.split('|') ;

        if (button_data !== undefined)
            button_data_list = button_data.split('|') ;

        // loop through each possible variable in score_var
        // (These are button click variables)

        score_var_list.forEach(function(sv, index){

            // get the text string from this index of pipe separated values
            let bd = '' ;
            if (button_data_list[index] !== undefined)
                bd = button_data_list[index] ;

            // get the default value, or the individual index value item if there's a separator
            let v = value ;
            if ($.isNumeric(bd))
                v = Number(bd) ;

            if ((v == 0) && (bd != '') && (bd != '0')) {
                // reset value to zero with this special string. Other strings that start with = get turned into negative numbers
                if (bd == '=0')
                    assignSessionVar(sv, 0);
                else {

                    // do variable within variable string substitution (ZA-556)
                    // i.e.: if a variable has something like #name# in it, substitute the value of the name variable

                    if ((typeof bd === 'string') && (bd.indexOf ('#') != -1)) {

                        for (var key in form_data)
                            bd = bd.replace('#' + key + '#', form_data[key]);
                    }

                    assignSessionVar(sv, bd);
                }
            }

            // set scoring variable to a value - either running total or absolute
            else if (persistent_button_return_node == 0) {


                if (form_data[sv] === undefined) {
                    assignSessionVar(sv, Math.abs(v));
                } else {
                    // convert strings to numbers if possible
                    if ((typeof form_data[sv] === 'string') && ($.isNumeric(form_data[sv])))
                        assignSessionVar(sv, Number(form_data[sv]));
                        
                    //  keep running total if value >0, and if current variable is a numeric type
                    if ((v >= 0) && (typeof form_data[sv] === 'number'))
                        assignSessionVar(sv, Number(form_data[sv]) + v);   // prevent unwanted string addition

                    // otherwise just set value to absolute value if negative
                    else
                        assignSessionVar(sv, -1 * v);
                }
            }


        }) ;


        // tree nodes here
        // load the tree, and let everything else take it's course

        if (trees[this_tree_id].nodes[show].type == "Tree") {

            // add previous form data to stack

            if (keep_vars_on_back != 1)
                form_data_history.push(fd2);


            $.each(form_data, function (key, value) {
                set_variable(key, value);
            });



            // save tree launch history and return node if we're jumping to a valid tree

            if (trees[this_tree_id].nodes[show].open_tree_id > 1) {
                if (persistent_button_return_node == 0)
                    push_tree_launch_history(this_tree_id, trees[this_tree_id].nodes[show].return_tree_node_id);


                // special case to return to previous node when launching a tree via a persistent button

                else {
                    push_tree_launch_history(this_tree_id, persistent_button_return_node);
                    persistent_button_return_node = 0;
                }

                // get new node and tree

                open_tree_node_id = trees[this_tree_id].nodes[show].open_tree_node_id;    // start node for new tree (read this before changing this_tree_id below)
                this_tree_id = trees[this_tree_id].nodes[show].open_tree_id;    // sets current tree


            }

            // new tree is 0 or 1 (return), so see if we have a tree and return node in our launch stack

            else {

                // if we have something in the launch stack, get it and use the tree and node. This is the "return" capability.
                if ((tree_launch_history.length > 0) & (trees[this_tree_id].nodes[show].open_tree_id == 1)) {

                    this_tree_id = tree_launch_history.pop();
                    open_tree_node_id = tree_launch_return_node_history.pop();
                }

                // nothing in launch stack, or unspecified tree, so we can return an error

                else {

                    this_tree_id = 0;
                    open_tree_node_id = 0;

                }

            }


            // update some of the stack now, and let the load_tree() launch action update the rest after the tree is loaded

            // show persistent buttons differently
            if (button_text.substr(0, 4) == "*PB*") {
                bt = button_text.substr(4);
                button_text_history.push('<span class="btn btn-default btn-sm">' + bt + '</span><br>');
            }

            // normal button text
            else {
                if ((hide != 1002) && (hide != 1003) && (hide != 1004))
                    last_question = trees[last_tree_id].nodes[hide].question;
                else {
                    last_question = "Result:";    // no questions for search results
                    button_text = trees[last_tree_id].nodes[show].page_title_plain;
                }

                // remove class overrides from button text if present

                var history_button_text = button_text;
                if (button_text.substr(0, 5) == '.btn-')
                    history_button_text = button_text.slice(1 + button_text.indexOf(' '));

                button_text_history.push('<span class="zt-history-question">' + last_question + '</span> <span class="zt-history-answer">' + history_button_text + ' </span><br>');
            }


            // set some globals for tracking call in load_tree()

            last_node_id = hide;
            last_value = value;
            last_button_text = button_text;

            // load the tree, and do the launch action

            if (this_tree_id > 1) {
                load_tree(this_tree_id, "launch", open_tree_node_id);

            }

            // no tree specified? try to return to previous tree

            else {
                if (this_tree_id == 0)
                    alert('Zingtree message: An attempt to load a new tree occurred, but no valid tree was specified. Check node #' + hide + ' in tree #' + last_tree_id + '.');
                else
                    alert('Zingtree message: A Tree return request was received, but there is no previous tree to return to.');

                this_tree_id = last_tree_id;
            }
            return;
        }


// save new node in breadcrumb/history

        // link nodes or email nodes with an automatic continuation don't alter the history stack
        if ((trees[this_tree_id].nodes[show].type != "Link") && (trees[this_tree_id].nodes[show].email_send_now != 1)) {
            button_history.push(show);
            tree_history.push(this_tree_id);

            // add previous form data to stack

            if (keep_vars_on_back != 1)
                form_data_history.push(fd2);

            // show persistent buttons differently
            if (button_text.substr(0, 4) == "*PB*") {
                bt = button_text.substr(4);
                button_text_history.push('<span class="btn btn-default btn-sm">' + bt + '</span><br>');
            }

            // normal button text
            else {

                if ((hide != 1002) && (hide != 1003))
                    last_question = trees[last_tree_id].nodes[hide].question;
                else {
                    last_question = "Result:";    // no questions for search results
                    button_text = trees[this_tree_id].nodes[show].page_title_plain;
                }

                var history_button_text = button_text;
                if (button_text.substr(0, 5) == '.btn-')
                    history_button_text = button_text.slice(1 + button_text.indexOf(' '));

                button_text_history.push('<span class="zt-history-question">' + last_question + '</span> <span class="zt-history-answer">' + history_button_text + ' </span><br>');

            }


            log('show = ' + show);
            log('hide = ' + hide);

            // if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame
            // if hosted, scroll to top of page on a click

            fix_scroll();

        }


// show the latest node, scores and history

        refresh_display();
        

// make a string from form data to send to click tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


// get the resolution_state for results tracking

        resolution_state = trees[this_tree_id].nodes[to_node_id].resolution_state;
        signalResolution(resolution_state);

        


        
// async log the button click event

        if (trees[this_tree_id].nodes[show].type != "Link") {
            set_escalation(60 * trees[this_tree_id].nodes[show].escalate_after);


            ++click_num;   // used to keep click events in sync

            // use (auto) for click text logging if we're jumping from an email node continuation
            var ct;
            if ((hide < 1000) && (trees[hide_tree].nodes[hide].type == "Email"))
                ct = "(auto)";
            else
                ct = button_text;

            var request = $.ajax({
                url: tracking_url,
                method: "POST",
                data: {
                    source: source,
                    agent_mode: agent_mode,
                    tree_id: trees[this_tree_id].tree_id,
                    master_tree_id: master_tree_id,
                    session_id: session_id,
                    from: hide,
                    to: to_node_id,
                    click_text: ct,
                    score: value,
                    form_data: form_data_string,
                    resolution_state: resolution_state,
                    instance: "2",
                    click_num: click_num,
                    tag: trees[this_tree_id].nodes[show].tag,
                    escalate_after: trees[this_tree_id].nodes[show].escalate_after
                },
                async: true,
                dataType: "html",
                uid: uid
            });

            request.done(function (msg) {
                log(msg);
                if (is_process)
                    update_history_display();


                // if there's a js message to send to the parent, send it now
                // we do this here so that the session data can be sent first

                if (trees[click_tree_id].nodes[show].jsmessage != '') {
                    var msg = trees[click_tree_id].nodes[show].jsmessage;   // get the message
                    msg = msg.replace("#session#", session_id);           // substitute the session ID if needed

                    // sunstitute form data into JS message placeholders
                    $.each(form_data, function (key, value) {

                        if (key != '') {
                            zt_var = escapeRegExp('#' + key + '#');
                            re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                            if (msg.indexOf(zt_var) == 0)
                                msg = msg.replace(re, value); 	// don't URI Encode value if replacing the entire link variable
                            else
                                msg = msg.replace(re, encodeURIComponent(value));

                        }

                    });


                    parent.postMessage(msg, "*");                            // send to the hosting iFrame
                }


            });
        }


// send app messages

        // show a spinner while calling webhooks
        if (typeof trees[this_tree_id].nodes[show].app_messages[0] !== 'undefined')
            $("#link-wait").show();

        form_changes = {};
        for (i = 0; i < 10; ++i) {
            if (typeof trees[this_tree_id].nodes[show].app_messages[i] === 'undefined')
                break;

            var request2 = $.ajax({
                url: app_message_url,
                method: "POST",
                data: {
                    master_tree_id: master_tree_id,
                    tree_id: this_tree_id,
                    session_id: session_id,
                    app: trees[this_tree_id].nodes[show].app_messages[i].app,
                    app_id: trees[this_tree_id].nodes[show].app_messages[i].app_id,
                    message: trees[this_tree_id].nodes[show].app_messages[i].message,
                    form_data: form_data_string,
                    source: source,
                    node_number: show,
                    from_node_number: hide,
                    auth_token: auth_token,
                    sf_id: ''
                },
                async: false,  // ** was TRUE -- makes it so that webhooks and apps finish before we continue.
                timeout: 15000,     // give the scripts 15 seconds
                dataType: "html",
                uid: uid
            });

            request2.done(function (msg) {
                log(msg);
                $("#link-wait").hide();

                if (msg[0] == '*')
                    alert(msg);
                else {

                    // add JSON result to form_data
                    // refresh the display after we receive data (if we receive any data)

                    var do_refresh = 0;
                    if (msg != '') {
                        try {
                            var json = JSON.parse(msg);

                            for (var key in json) {
                                // ensure webhook results are not arrays
                                if (Array.isArray(json[key]) === false) {
                                    // turn NULL values into empty strings

                                    if (json[key] == null)
                                        json[key] = '';

                                    // add new variable to form data
                                    form_changes[key] = form_data[key] = json[key];
                                    do_refresh = 1;
                                }
                            }
                        } catch (e) {
                        }
                    }

                    if (do_refresh == 1)
                        refresh_display();

                }

            });

        }
        emitEvent('webhooksComplete', form_changes);


        // update data fields in containing app (i.e. CRM/Zendesk integration)

        $.each(form_data, function (key, value) {
            set_variable(key, value);
        });



        
        



// handle link nodes here

        if (trees[this_tree_id].nodes[show].type == "Link") {
            var link_node_tree_id = this_tree_id;   // save the tree where this link node originated from - in case this_tree_id changes

            // hide the node so it's not clicked upon again
            // also surface a "please wait" message

            $(".zingtree-node").hide();
            $(".persistent-buttons").hide();
            $("#link-wait").show();

            // track the event, then jump to link once the tracking has finished
            // this ensures everything is up to date with tracking before we link out

            ++click_num;   // used to keep click events in sync

            var request = $.ajax({
                url: tracking_url,
                method: "POST",
                data: {
                    source: source,
                    agent_mode: agent_mode,
                    tree_id: trees[this_tree_id].tree_id,
                    master_tree_id: master_tree_id,
                    session_id: session_id,
                    from: hide,
                    to: to_node_id,
                    click_text: button_text,
                    score: value,
                    form_data: form_data_string,
                    resolution_state: resolution_state,
                    instance: "2",
                    click_num: click_num
                },
                async: true,
                dataType: "html",
                uid: uid
            });

            request.done(function (msg) {
                log(msg);


                // if there's a js message to send to the parent, send it now
                // we do this here so that the session data can be sent first

                if (trees[click_tree_id].nodes[show].jsmessage != '') {
                    var msg = trees[click_tree_id].nodes[show].jsmessage;   // get the message
                    msg = msg.replace("#session#", session_id);           // substitute the session ID if needed

                    // sunstitute form data into JS message placeholders
                    $.each(form_data, function (key, value) {

                        if (key != '') {
                            zt_var = escapeRegExp('#' + key + '#');
                            re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                            if (msg.indexOf(zt_var) == 0)
                                msg = msg.replace(re, value); 	// don't URI Encode value if replacing the entire link variable
                            else
                                msg = msg.replace(re, encodeURIComponent(value));

                        }

                    });

                    parent.postMessage(msg, "*");                            // send to the hosting iFrame
                }


                var link = trees[link_node_tree_id].nodes[show].link;

                // replace session ID, agent and source in link (if present)

                link = link.replace(/[\u200B-\u200D\uFEFF]/g, '');  // eliminate &zwnj; from text copies from FAQ
                link = link.replace('#session#', session_id);
                link = link.replace('#agent#', source);
                link = link.replace('#source#', source);


                // replace form data vars in link

                $.each(form_data, function (key, value) {

                    if (key != '') {
                        zt_var = escapeRegExp('#' + key + '#');
                        re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                        if (link.indexOf(zt_var) == 0)
                            link = link.replace(re, value); 	// don't URI Encode value if replacing the entire link variable
                        else
                            link = link.replace(re, encodeURIComponent(value));

                    }

                });


                // replace merge variables in link

                $.each(zt_vars, function (i, zt_var) {

                    zt_var = escapeRegExp('#' + zt_var + '#');
                    re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                    link = link.replace(re, zt_vals[i]);

                });


                if (trees[link_node_tree_id].nodes[show].link_new_tab == 1)     // open in new tab
                {
                    // restore tree from last node since a new tab window is opening

                    $(".persistent-buttons").show();
                    $("#link-wait").hide();

                    $("#node-" + this_tree_id + '-' + hide).show();


                    window.open(link, '_blank');
                }
                // open in current tab
                else
                    window.top.location.href = link;

            });

            return;
        }

// Email nodes - automatic send

        if ((trees[this_tree_id].nodes[show].type == "Email") && (trees[this_tree_id].nodes[show].email_send_now == 1)) {

// substitute the form data variables in various parts of the email

            var email_subject = trees[this_tree_id].nodes[show].email_subject;
            var email_preheader = trees[this_tree_id].nodes[show].email_preheader;
            var email_body = trees[this_tree_id].nodes[show].email_body;
            var email_recipients = trees[this_tree_id].nodes[show].email;
            var email_sender_name = trees[this_tree_id].nodes[show].email_sender_name;
            var email_reply_to = trees[this_tree_id].nodes[show].email_reply_to;
            var email_bcc = trees[this_tree_id].nodes[show].email_bcc;


            $.each(form_data, function (key, value) {

                if (key != '') {
                    zt_var = escapeRegExp('#' + key + '#');
                    re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one
                    email_sender_name = email_sender_name.replace(re, encodeURIComponent(value));
                    email_recipients = email_recipients.replace(re, encodeURIComponent(value));
                    email_subject = email_subject.replace(re, encodeURIComponent(value));
                    email_preheader = email_preheader.replace(re, encodeURIComponent(value));
                    email_body = email_body.replace(re, encodeURIComponent(value));
                    email_reply_to = email_reply_to.replace(re, encodeURIComponent(value));
                    email_bcc = email_bcc.replace(re, encodeURIComponent(value));

                }

            });

// also replace the session ID

            re = new RegExp('#session#', "g");
            email_body = email_body.replace(re, session_id);

            re = new RegExp('#agent#', "g");
            email_body = email_body.replace(re, source);


// insert current agent name and login (email) (if exists)

            email_recipients = email_recipients.replace('#current_agent_login#', agent_email);
            email_reply_to = email_reply_to.replace('#current_agent_login#', agent_email);
            email_bcc = email_bcc.replace('#current_agent_login#', agent_email);
            email_subject = email_subject.replace('#current_agent_login#', agent_email);
            email_sender_name = email_sender_name.replace('#current_agent_login#', agent_email);

            re = new RegExp('#current_agent_login#');
            email_body = email_body.replace(re, agent_email);


            email_recipients = email_recipients.replace('#current_agent_name#', agent_name);
            email_reply_to = email_reply_to.replace('#current_agent_name#', agent_name);
            email_bcc = email_bcc.replace('#current_agent_name#', agent_name);
            email_subject = email_subject.replace('#current_agent_name#', agent_name);
            email_sender_name = email_sender_name.replace('#current_agent_name#', agent_name);

            re = new RegExp('#current_agent_name#', "g");
            email_body = email_body.replace(re, agent_name);


            // send the message asynchronously

            $("#link-wait").show();

            var request3 = $.ajax({
                url: email_autosend_url,
                method: "POST",
                data: {
                    subject: email_subject,
                    preheader: email_preheader,
                    recipients: email_recipients,
                    sender_name: email_sender_name,
                    reply_to: email_reply_to,
                    bcc: email_bcc,
                    body: email_body,
                    data_privacy: trees[this_tree_id].nodes[show].email_data_privacy,
                    include_session_data: trees[this_tree_id].nodes[show].email_include_session_data,
                    session_id: session_id,
                    project_id: this_tree_id,
                    node_id: show,
                    send_as_html: 1,
                    all_in_one: 1

                },
                async: true,
                dataType: "html",
                uid: uid
            });

            request3.done(function (msg) {
                log(msg);
                $("#link-wait").hide();


            });


// go to continuation node

            $("#link-wait").hide();
            var next_node = trees[this_tree_id].nodes[show].continuation_node_id;
            if (next_node == 0)
                alert("No next node specified for Email node #" + show);
            else {
                // keep hash in sync
                ignore_hash_change = 1;
                do_button_click(next_node, show, button_text, value, button_data);

            }

            return;

        }

// Document nodes

        if (trees[this_tree_id].nodes[show].type == "Document") {

// PDF document node - make the PDF, and store in the PDF URL variable
// same for HTML File document node

            if (
                (trees[this_tree_id].nodes[show].doc_node_type == 'pdf')  ||
                (trees[this_tree_id].nodes[show].doc_node_type == 'html_file'))  {

                $("#node-" + this_tree_id + "-" + show).hide();
                $("#pdf-wait").show();

            // use different URLS to generater the HTML or PDF files
                var generate_url ;
                if (trees[this_tree_id].nodes[show].doc_node_type == 'html_file') {
                    generate_url = html_generate_url ;
                }  else {
                    generate_url = pdf_generate_url ;
                }



                // generate the PDF/HTML file asynchronously

                var request4 = $.ajax({
                    url: generate_url,
                    method: "POST",
                    data: {
                        session_id: session_id,
                        tree_id: this_tree_id,
                        node_id: show,
                        download: 0,
                        form_data: form_data_string

                    },
                    async: true,
                    dataType: "html",
                    uid: uid
                });

                request4.done(function (msg) {
                    log(msg);
                    $("#pdf-wait").hide();
                    form_data[trees[this_tree_id].nodes[show].pdf_url_variable] = msg;

                    // go to continuation node

                    var next_node = trees[this_tree_id].nodes[show].continuation_node_id;
                    if (next_node == 0)
                        alert("No next node specified for Document node #" + show);
                    else {
                        // keep hash in sync
                        ignore_hash_change = 1;
                        do_button_click(next_node, show, button_text, value, button_data);

                    }


                });


                return;
            }

// HTML document node - show the node contents

            // load each check for including nodes, and see if the include condition applies

            $("#document-node-" + show).html('');    // erase last rendered contents

            var nodes_in_document = [];            // maintains a list of nodes already inserted

            // get a list of nodes from the advanced doc node logic evaluator

            if (trees[this_tree_id].nodes[show].advanced_logic_node == 1) {
                // ensure the form data string is up to date
                // most likely from a webhook update that hasn't yet rebuilt this

                form_data_string = make_form_data_string(form_data);

                // evaluate the logic node, and get the next node to visit
                var request = $.ajax({
                    url: advanced_docnode_logic_node_evaluator_url,
                    method: "POST",
                    data: {form_data: form_data_string, tree_id: this_tree_id, node_id: show},
                    async: true,
                    dataType: "html"
                });


                request.done(function (data) {
                    if (data[0] == '*') // errors have '*' as first character
                        alert(data);
                    else {

                        // data contains a list of nodes, separated by |
                        // let's add these nodes to the document node area

                        nodes_in_document = data.split('|');

                        nodes_in_document.forEach(function (doc_node) {
                            html = $("#node-" + this_tree_id + "-" + doc_node + " #content-answer-" + doc_node).html();
                            $('#node-' + this_tree_id + '-' + show + ' #document-node-' + show).append(html);
                        });
                    }

                });


            }

            // handle simple doc node generation
            else {

                for (i = 0; i < trees[this_tree_id].nodes[show].buttons.length; i++) {
                    var v = trees[this_tree_id].nodes[show].buttons[i].button_text;
                    var op = trees[this_tree_id].nodes[show].buttons[i].op;
                    var val2 = trees[this_tree_id].nodes[show].buttons[i].button_data;
                    var doc_node = trees[this_tree_id].nodes[show].buttons[i].button_link;


                    if ((v == '*') ||                                  // always include
                        ((typeof form_data[v] !== "undefined") &&      // make sure we have a variable
                            (doc_node != 0) &&                             // skip unspecified nodes
                            (nodes_in_document.indexOf(doc_node) == -1))    // don't insert a node more than once
                    ) {


                        // do the test based upon the operation

                        if (v == '*')    // always include
                            test_ok = true;
                        else {
                            val1 = form_data[v];    // the variable value to test against

                            // is val2 a variable? If so, extract the variable name and look it up! Makes sure it's a real variable, otherwise leaves string intact
                            // i.e. #name#

                            if (val2[0] == '#') {
                                v2 = val2.trim().slice(1, -1);   // trim whitespace, and ending and starting # characters
                                if (typeof form_data[v2] !== "undefined")
                                    val2 = form_data[v2];
                            }

                            // see if these should be number comparisons instead

                            if (($.isNumeric(val1)) && ($.isNumeric(val2))) {
                                val1 = Number(val1);
                                val2 = Number(val2);
                            }

                            var test_ok = false;    // assume fail
                            switch (op) {

                                case "eq":
                                    test_ok = (val1 == val2);
                                    break;

                                case "ne":
                                    test_ok = (val1 != val2);
                                    break;

                                case "lt":
                                    test_ok = (val1 < val2);
                                    break;

                                case "gt":
                                    test_ok = (val1 > val2);
                                    break;

                                case "lte":
                                    test_ok = (val1 <= val2);
                                    break;

                                case "gte":
                                    test_ok = (val1 >= val2);
                                    break;

                                case "cont":
                                    if ((typeof val1 == "string") && (typeof val2 == "string"))
                                        test_ok = -1 != val1.indexOf(val2);
                                    else
                                        test_ok = false;
                                    break;

                            }
                        }

                        // add the node's contents to the document node

                        if (test_ok) {
                            html = $("#node-" + this_tree_id + "-" + doc_node + " #content-answer-" + doc_node).html();

                            $('#node-' + this_tree_id + '-' + show + ' #document-node-' + show).append(html);
                            nodes_in_document.push(doc_node);          // add this to the list so we don't insert it again
                        }
                    }

                }

                // hide the question area, confirmation text, permalink
            }

            $('#node-' + this_tree_id + '-' + show + " #question_area").hide();
            $('#node-' + this_tree_id + '-' + show + " #qa-area").hide();

            $('#node-' + this_tree_id + '-' + show + " #node-confirmation").hide();
            $('#node-' + this_tree_id + '-' + show + " .permalink").hide();

            refresh_display();
            return;
        }


        // Scoring/Logic nodes

        if (trees[this_tree_id].nodes[show].type == "Scoring")
            do_logic_jump(show);


    }


    // do the Logic Node jump
    // handles A/B testing, legacy "Scoring Nodes", 2017 Logic Nodes

    function do_logic_jump(node_id) {

// branch to the desired node based upon score

        if (trees[this_tree_id].nodes[node_id].randomize_scoring == 0) {

            // load the scoring variable from this scoring node
            score_var = trees[this_tree_id].nodes[node_id].score_var;

            // if we have a variable set, handle old-style scoring nodes, with values and ranges
            if (score_var != '') {

                // make sure we have a value so script doesn't end with an error
                if (typeof form_data[score_var] !== "undefined")
                    my_score = Number(form_data[score_var]);
                else
                    my_score = 0;

                // find the branch for this score
                for (i = 0; i < trees[this_tree_id].nodes[node_id].buttons.length; i++) {
                    if (my_score <= Number(trees[this_tree_id].nodes[node_id].buttons[i].value)) {
                        // keep hash in sync
                        ignore_hash_change = 1;

                        do_button_click(trees[this_tree_id].nodes[node_id].buttons[i].button_link, node_id, '*SB* Logic Node Branch', 0);
                        return;
                    }
                }

                alert("Node #" + node_id + ": 1. No scoring option applied for score=" + my_score);
            }

            // handle newer logic nodes: variables, operations and values

            else {

                // keep hash in sync
                ignore_hash_change = 1;


                // advanced logic nodes
                // use server-side parser to evaluate expressions and jump to the requested node
                // script returns node to go to

                if (trees[this_tree_id].nodes[node_id].advanced_logic_node == 1) {

                    // ensure the form data string is up to date
                    // most likely from a webhook update that hasn't yet rebuilt this

                    form_data_string = make_form_data_string(form_data);

                    // evaluate the logic node, and get the next node to visit
                    var request = $.ajax({
                        url: advanced_logic_node_evaluator_url,
                        method: "POST",
                        data: {form_data: form_data_string, tree_id: this_tree_id, node_id: node_id},
                        async: true,
                        dataType: "html"
                    });


                    request.done(function (data) {
                        if (data[0] == '*') // errors have '*' as first character
                            alert(data);
                        else
                            do_button_click(data, node_id, '*SB* Logic Branch', 0);

                        return;
                    });

                }


                // simple logic nodes
                else {

                    // do each test, and see if it is valid
                    // if so, branch to the new node

                    for (i = 0; i < trees[this_tree_id].nodes[node_id].buttons.length; i++) {
                        var variable = trees[this_tree_id].nodes[node_id].buttons[i].button_text;     // variable
                        var op = trees[this_tree_id].nodes[node_id].buttons[i].op;                    // operation
                        var test_value = trees[this_tree_id].nodes[node_id].buttons[i].button_data.trim();   // test value

                        var result = false;
                        var a, b;

                        // default action - always branch
                        if (op == "def")
                            result = true;

                        // do a test depending upon the operation
                        else {
                            if (typeof form_data[variable] !== "undefined") // make sure we have this variable set, otherwise we'll just skip
                            {

                                // try to convert both sides if the equation into numbers
                                // if one side cannot be converted, keep both as strings

                                a = +form_data[variable];
                                b = +test_value;

                                if ((isNaN(a)) || (isNaN(b))) {
                                    if (typeof form_data[variable] === "string")
                                        a = form_data[variable].trim();
                                    b = test_value;
                                }

                                switch (op) {
                                    case 'eq':
                                        result = a == b;
                                        break;

                                    case 'ne':
                                        result = a != b;
                                        break;

                                    case 'lt':
                                        result = a < b;
                                        break;

                                    case 'lte':
                                        result = a <= b;
                                        break;

                                    case 'gt':
                                        result = a > b;
                                        break;

                                    case 'gte':
                                        result = a >= b;
                                        break;

                                    case 'cont':
                                        if ((typeof a == "string") && (typeof b == "string"))
                                            result = -1 != a.indexOf(b);
                                        else

                                            result = false;

                                        break;
                                }
                            }

                        }


                        // if the condition was set, branch to the desired node

                        if (result) {
                            do_button_click(trees[this_tree_id].nodes[node_id].buttons[i].button_link, node_id, '*SB* Logic Branch', 0);

                            return;
                        }

                    }
                }

            }


        }


        // A/B test option: pick an item from the scoring nodes at random

        else {

            i = Math.floor(Math.random() * (trees[this_tree_id].nodes[node_id].buttons.length));

            // keep hash in sync
            ignore_hash_change = 1;

            do_button_click(trees[this_tree_id].nodes[node_id].buttons[i].button_link, node_id, '*SB* AB Test Branch', 0);
            return;


        }


    }


    // go back through history N steps

    function history_back(steps, back_button) {

// handle fade effect. Run the fadeOut part first, then recall this function with negative steps
// this ensures the FadeOut completes, and we reverse the negative steps next time and don't rerun the fadeOut

        if (steps < 0)
            steps = steps * -1;
        else {
            if (transition == 'fade') {

                // regular nodes
                if (this_node_id < 1000) {

                    // wait until fadeOut completes, then restart the history_back() call
                    $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                        $('#node-' + this_tree_id + '-' + this_node_id).hide();
                        history_back(-1 * steps, back_button);

                    });
                }

                // special search nodes
                else {

                    // wait until fadeOut completes, then restart the history_back() call
                    $('#node' + hide).fadeOut(transition_duration, function () {
                        history_back(-1 * steps, back_button);
                    });
                }

                return;

            }
        }


// clear current form data, unless we're at the top, or we're supposed to keep the data

        if ((steps > 0) && (keep_vars_on_back != 1) && (form_data_history.length > 0)) {

            // empty the values from our global form_data
            $.each(form_data, function (key, value) {
                form_data[key] = '';
                //          $("input[name='".key."']" ).val('') ;  // erase form field as well
            });

            // refresh the node display with empty values
            // if we're in a fade transition, this caused old node to reappear, so we don't refresh here

            if (transition != 'fade')
                refresh_display();

        }

        // iterate through a number of steps

        var unscore = 0;
        var new_node;
        var last_node = -1;    // this will get set to a real node number if it's a bonafide "back" request. if it stays at -1, then we don't log a fake "back"
        var last_tree_id;

        for (i = 0; i < steps; ++i) {
            last_tree_id = this_tree_id;

            // this should never happen, but just in case...

            if (button_history.length == 1)
                break;

            // pop the last node off the stack
            last_node = button_history.pop();
            tree_history.pop();
            this_tree_id = tree_history[tree_history.length - 1];

            button_text_history.pop();
            tag = tag_history.pop();

            if (keep_vars_on_back != 1)
                form_data = form_data_history.pop();

            

            new_node = button_history[button_history.length - 1];

            // landing on a logic node, auto email node or a PDF document node? go back one more

            while (
                (new_node < 1000) && (
                    (trees[this_tree_id].nodes[new_node].type == "Scoring") ||
                    ((trees[this_tree_id].nodes[new_node].type == "Document") && (trees[this_tree_id].nodes[new_node].doc_node_type == "pdf")) ||
                    ((trees[this_tree_id].nodes[new_node].type == "Document") && (trees[this_tree_id].nodes[new_node].doc_node_type == "html_file")) ||
                    ((trees[this_tree_id].nodes[new_node].type == "Email") && (trees[this_tree_id].nodes[new_node].email_send_now == 1))
                )
                ) {
                button_history.pop();
                tree_history.pop();

                button_text_history.pop();
                tag_history.pop();

                if (keep_vars_on_back != 1)
                    form_data = form_data_history.pop();

                ++i;   // keep counter in sync, since we skipped one

                new_node = button_history[button_history.length - 1];
                this_tree_id = tree_history[tree_history.length - 1];

            }


            // node to show is the one remaining at the end of the stack
            this_node_id = button_history[button_history.length - 1];
            this_tree_id = tree_history[tree_history.length - 1];

            // replace last tree and node on tree node "return" stack if tree has changed
            if (this_tree_id != last_tree_id)
                push_tree_launch_history(last_tree_id, last_node);

        }

        // make sure we didn't pop too far
        if (typeof form_data === 'undefined')
            form_data = {};

// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        parent.postMessage("Treename=" + trees[this_tree_id].name, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


// update the display with the new form_data and new node

        refresh_display();


// log history button click like a permanent button

        if (steps > 1)
            back_text = '*PB*History: Back ' + steps + ' steps';
        else {
            if (is_process) {
                if (steps == 1)
                    back_text = "*PB*Revisit: Back 1 step";
                else
                    back_text = "*PB*Revisit: Back " + steps + " steps";
            } else if (back_button)
                back_text = '*PB*Back';
            else
                back_text = '*PB*History: Back 1 step';

        }

// get the resolution_state for results tracking

        var resolution_state;
        if ((this_node_id < 1000) && (typeof trees[this_tree_id].nodes[this_node_id].resolution_state !== "undefined"))
            resolution_state = trees[this_tree_id].nodes[this_node_id].resolution_state;

        // search or other special nodes are "unknown" result
        else
            resolution_state = '?';

        signalResolution(resolution_state);

// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');

        

// get tag for logging
// if it's a special node, then there's no tag

        var this_tag;
        if (this_node_id < 1000)
            this_tag = trees[this_tree_id].nodes[this_node_id].tag;
        else
            this_tag = '';

        set_escalation(60 * trees[this_tree_id].nodes[this_node_id].escalate_after);

        if (last_node != -1) {
            ++click_num;   // keep click events in sync

            var request = $.ajax({
                url: tracking_url,
                method: "POST",
                data: {
                    source: source,
                    agent_mode: agent_mode,
                    tree_id: trees[this_tree_id].tree_id,
                    master_tree_id: master_tree_id,
                    session_id: session_id,
                    from: last_node,
                    to: this_node_id,
                    click_text: back_text,
                    steps_back: steps,
                    resolution_state: resolution_state,
                    form_data: form_data_string,
                    instance: "3",
                    click_num: click_num,
                    tag: this_tag,
                    escalate_after: trees[this_tree_id].nodes[this_node_id].escalate_after
                },
                async: true,
                dataType: "html",
                uid: uid

            });

            request.done(function (msg) {
                log(msg);

                // use new stack to updatethe task history
                if (is_process)
                    update_history_display();

            });
        }

        

        // keep hash in sync for back button detection

        window.location.hash = this_node_id;
    }


    // go back one level

    function go_back() {
        history_back(1, true);

    }


    // start again
    // called from UI

    function restart(clicktext) {

        // fade out the current node before entering the restart process

        if (transition == 'fade') {

            // fade out normal nodes
            if (this_node_id < 1000) {

                // wait until fadeOut completes, then complete restart()
                $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                    restart_go(clicktext);
                });
            }

            // fade out special search nodes
            else {
                // wait until fadeOut completes, then complete restart()
                $('#node' + this_node_id).fadeOut(transition_duration, function () {
                    restart_go(clicktext);
                });
            }


            return;

        }

        restart_go(clicktext);
    }


    // handle second part of restart process

    function restart_go(clicktext) {

        var from_node_id = this_node_id;

// go back to first node and tree

        this_node_id = restart_node_id;
        this_tree_id = restart_tree_id;


// reset the history stacks

        button_history = [];
        button_history.push(this_node_id);

        tree_history = [];
        tree_history.push(this_tree_id);

        button_text_history = [];
        button_text_history.push('Start');

        

        tag_history = [];


// reload form data from merge variables, optional location info

        form_data_history = [];

        // empty the values from our global form_data
        if (keep_vars_on_back != 1) {
            $.each(form_data, function (key, value) {
                form_data[key] = '';
            });
        }


        // refresh the node display with empty values
        refresh_display();

        // reinitialize form data from merge variables (unless we're supposed to keep it)
        if (keep_vars_on_back != 1)
            init_form_data();



// send app messages after restart

        // show a spinner while calling webhooks
        if (typeof trees[this_tree_id].nodes[this_node_id].app_messages[0] !== 'undefined')
            $("#link-wait").show();

        form_changes = {};
        for (i = 0; i < 10; ++i) {
            if (typeof trees[this_tree_id].nodes[this_node_id].app_messages[i] === 'undefined')
                break;

            var request2 = $.ajax({
                url: app_message_url,
                method: "POST",
                data: {
                    master_tree_id: master_tree_id,
                    tree_id: this_tree_id,
                    session_id: session_id,
                    app: trees[this_tree_id].nodes[this_node_id].app_messages[i].app,
                    app_id: trees[this_tree_id].nodes[this_node_id].app_messages[i].app_id,
                    message: trees[this_tree_id].nodes[this_node_id].app_messages[i].message,
                    form_data: form_data_string,
                    source: source,
                    node_number: this_node_id,
                    from_node_number: from_node_id,
                    auth_token: auth_token,
                    sf_id: ''
                },
                async: false,  // ** was TRUE -- makes it so that webhooks and apps finish before we continue.
                timeout: 15000,     // give the scripts 15 seconds
                dataType: "html",
                uid: uid
            });

            request2.done(function (msg) {
                log(msg);
                $("#link-wait").hide();

                if (msg[0] == '*')
                    alert(msg);
                else {

                    // add JSON result to form_data
                    // refresh the display after we receive data (if we receive any data)

                    var do_refresh = 0;
                    if (msg != '') {
                        try {
                            var json = JSON.parse(msg);

                            for (var key in json) {
                                // ensure webhook results are not arrays
                                if (Array.isArray(json[key]) === false) {
                                    // turn NULL values into empty strings

                                    if (json[key] == null)
                                        json[key] = '';

                                    // add new variable to form data
                                    form_changes[key] = form_data[key] = json[key];
                                    do_refresh = 1;
                                }
                            }
                        } catch (e) {
                        }
                    }

                }

            });

        }
        emitEvent('webhooksComplete', form_changes);





        // redo display one more time with initted form data values
        refresh_display();


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


        log("RESTART");

// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        parent.postMessage("Treename=" + trees[this_tree_id].name, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });



        
        set_escalation(60 * trees[this_tree_id].nodes[this_node_id].escalate_after);


        // log the restart

        ++click_num;   // keep click events in sync

// log restart button click

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: from_node_id,
                to: this_node_id,
                click_text: '*PB*' + clicktext,
                steps_back: 999,
                resolution_state: '?',
                form_data: '',
                instance: "4",
                click_num: click_num,
                tag: trees[this_tree_id].nodes[this_node_id].tag,
                escalate_after: trees[this_tree_id].nodes[this_node_id].escalate_after
            },
            async: true,
            dataType: "html",
            uid: uid

        });


        request.done(function (msg) {
            log(msg);

        });

        

// logic nodes as root need to activate

        if (trees[this_tree_id].nodes[this_node_id].type == "Scoring") {
            do_logic_jump(this_node_id);
            return;
        }

        // tree nodes as root - launch the tree in the root node

        if (trees[this_tree_id].nodes[this_node_id].type == "Tree") {
            if (trees[this_tree_id].nodes[this_node_id].open_tree_id > 1) {
                open_tree_node_id = trees[this_tree_id].nodes[this_node_id].open_tree_node_id;    // start node for new tree (read this before changing this_tree_id below)
                this_tree_id = trees[this_tree_id].nodes[this_node_id].open_tree_id;    // sets current tree

                push_tree_launch_history(this_tree_id, trees[this_tree_id].nodes[this_node_id].return_tree_node_id);


                // load the tree, and do the launch action

                load_tree(this_tree_id, "launch", open_tree_node_id);
            }


            // try to do a "return" tree op

            else {

                // if we have something in the launch stack, get it and use the tree and node. This is the "return" capability.

                if ((trees[this_tree_id].nodes[this_node_id].open_tree_id == 1) && (tree_launch_history.length > 0)) {
                    this_tree_id = tree_launch_history.pop();
                    open_tree_node_id = tree_launch_return_node_history.pop();

                    load_tree(this_tree_id, "launch", open_tree_node_id);

                }

                // nothing in launch stack, so we can return an error

                else {

                    this_tree_id = 0;
                    open_tree_node_id = 0;

                }


            }


        }


    }


    // handles the submit for email forms

    function email_form_submit(place) {

// make sure we select the proper form
        id = '#node-' + this_tree_id + '-' + this_node_id;

// hide the form, and show "please wait"
        $(id).hide();
        $("#link-wait").show();

// substitute the form data variables in various parts of the email

        var email_subject = $(id + ' #subject').val();
        var email_body = $(id + ' #message').val();
        var email_recipients = trees[this_tree_id].nodes[this_node_id].email;
        var email_sender_name = $(id + ' #name').val();
        var email_reply_to = $(id + ' #email').val();

        $.each(form_data, function (key, value) {

            if (key != '') {
                zt_var = escapeRegExp('#' + key + '#');
                re = new RegExp(zt_var, "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one
                email_sender_name = email_sender_name.replace(re, encodeURIComponent(value));
                email_recipients = email_recipients.replace(re, encodeURIComponent(value));
                email_subject = email_subject.replace(re, encodeURIComponent(value));

            }

        });


// send the message asynchronously

        var request3 = $.ajax({
            url: email_autosend_url,
            method: "POST",
            data: {
                subject: email_subject,
                recipients: email_recipients,
                sender_name: email_sender_name,
                reply_to: email_reply_to,
                bcc: trees[this_tree_id].nodes[this_node_id].email_bcc,
                body: email_body,
                data_privacy: trees[this_tree_id].nodes[this_node_id].email_data_privacy,
                include_session_data: trees[this_tree_id].nodes[this_node_id].email_include_session_data,
                session_id: session_id,
                project_id: this_tree_id,
                node_id: this_node_id,
                attachment_url: $(id + ' #attachment_url').val(),
                all_in_one: 1


            },
            async: true,
            dataType: "html",
            uid: uid
        });

        request3.done(function (msg) {
            log(msg);

            $("#link-wait").hide();

            // go to continuation node

            var next_node = trees[this_tree_id].nodes[this_node_id].continuation_node_id;
            if (next_node != 0) {
                // keep hash in sync
                ignore_hash_change = 1;
                do_button_click(next_node, this_node_id, trees[this_tree_id].nodes[this_node_id].continuation_button_text, 0, '');

            }

            // go to return URL if no continuation node

            else {

                var return_url = trees[this_tree_id].nodes[this_node_id].email_return_url;
                if (return_url == '')
                    return_url = "https://zingtree.com/message-sent.php";

                window.location.href = return_url;
            }


        });


    }


    // handle form search from UI
    // manages the fade effect

    function do_form_search() {

        if (transition == 'fade') {

            // wait until fadeOut completes, then do the rest of the search
            $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                do_form_search_go();
            });

            return;


        }

        do_form_search_go();


    }


    // logic for form search

    function do_form_search_go() {
        var idnode = '#node-' + this_tree_id + '-';

// hide the current node
        hide = button_history[button_history.length - 1];

// show search results node

        this_node_id = 1002;
        button_history.push(this_node_id);
        tree_history.push(this_tree_id);

        fd2 = jQuery.extend({}, form_data);

        if (keep_vars_on_back != 1)
            form_data_history.push(fd2);


// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// get the search text from the current node form, and place it into the search term slot

        search_text = $(idnode + hide + " #zt-node-search input[name='keywords']").val();
        $("#node1002 #searchterm").text(search_text);

        button_text_history.push("Search: " + search_text + '<br>');

// make a list of pages that have the search text
// start with title and tag matches

        r = new RegExp(search_text, "i");  // case insensitive regex search

        var list1 = [];
        var alreadys = [];

        $.each(trees[this_tree_id].nodes, function (i, node) {
            // make sure it's a content node, not hidden from ssearch, and not excluded from user-only (scope == 2) or agent_only (scope == 1) searches
            if (
                (node.type == 'Content') &&
                (node.hide_from_search != 1) &&
                ((node.search_scope == 0) || ((node.search_scope == 1) && (agent_mode == 1)) || ((node.search_scope == 2) && (agent_mode == 0)))
            ) {

                // parse out HTML - just leave text in search

                var div = document.createElement("div");
                div.innerHTML = node.page_title;
                var page_title_text = div.innerText;

                // find nodes that match string in title, tags or keywords
                if ((-1 != page_title_text.search(r)) || (-1 != node.tag.search(r)) || (-1 != node.keywords.search(r))) {
                    list1.push({id: node.project_node_id, title: node.page_title_plain});
                    alreadys[node.project_node_id] = 1;
                }
            }

        });


        // sort the results by title
        list1.sort(function (a, b) {
            var x = a.title.toLowerCase();
            var y = b.title.toLowerCase();
            return x < y ? -1 : x > y ? 1 : 0;
        });

// make a list of page content matches not already in list1

        var list2 = [];
        $.each(trees[this_tree_id].nodes, function (i, node) {

            if (
                (node.type == 'Content') &&
                (node.hide_from_search != 1) &&
                ((node.search_scope == 0) || ((node.search_scope == 1) && (agent_mode == 1)) || ((node.search_scope == 2) && (agent_mode == 0)))
            ) {
                if (typeof alreadys[node.project_node_id] === "undefined") {
                    // find nodes that match string in content area

                    var div = document.createElement("div");
                    div.innerHTML = node.content.replace('<!--', '');  // leaves keywords in comment fields intact
                    var content_text = div.innerText;

                    if ((-1 != content_text.search(r)))
                        list2.push({id: node.project_node_id, title: node.page_title_plain});
                    else {
                        // look for target text in each button if not already found in the node's content area
                        var btn_found = false;
                        $.each(node.buttons, function (i, btn) {
                            if (-1 != btn.button_text.search(r))
                                btn_found = true;
                        });

                        if (btn_found) {
                            list2.push({id: node.project_node_id, title: node.page_title_plain});
                        }
                    }
                }
            }

        });


        // sort the results by title
        list2.sort(function (a, b) {
            var x = a.title.toLowerCase();
            var y = b.title.toLowerCase();
            return x < y ? -1 : x > y ? 1 : 0;
        });


// build HTML for the results

        results = '';
        $.each(list1, function (i, result_node) {
            results = results + '<li><a onmouseover="" style="cursor: pointer;"  onclick="do_button_click(' + result_node.id + ',1002,\'Search\', 0); ">' + result_node.title + '</a></li>';
//        results = results + '<li><a href="#'+result_node.id+'" onclick="do_button_click('+result_node.id+',1002,\'Search\', 0); ">'+result_node.title+'</a></li>' ;
        });

        results = results + "<br>";

        $.each(list2, function (i, result_node) {

            results = results + '<li><a onmouseover="" style="cursor: pointer;"  onclick="do_button_click(' + result_node.id + ',1002,\'Search\', 0); ">' + result_node.title + '</a></li>';
//        results = results + '<li><a href="#'+result_node.id+'" onclick="do_button_click('+result_node.id+',1002,\'Search\', 0); ">'+result_node.title+'</a></li>' ;
        });

// insert the search results into the search results node
        $("#node1002 #searchresults").html(results);


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();

// update the display and total score
        refresh_display();


// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


// async log the button click event

        
        ++click_num;   // keep click events in sync

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source, agent_mode: agent_mode, tree_id: trees[this_tree_id].tree_id, master_tree_id: master_tree_id, session_id: session_id,
                from: hide, to: this_node_id, click_text: 'Search: ' + search_text, resolution_state: '?', form_data: form_data_string,
                instance: "5", click_num: click_num, tag: ''
            },
            async: true,
            dataType: "html",
            uid: uid

        });

        request.done(function (msg) {
            log(msg);

        });

        
        return (false);    // return false to ensure form is not actually submitted

    }


    // handle all trees search (title and tags)

    function do_find_tree() {

        var idnode = '#node-' + this_tree_id + '-';

// hide the current node
        hide = button_history[button_history.length - 1];

// show search results node

        this_node_id = 1004;
        button_history.push(this_node_id);
        tree_history.push(this_tree_id);

        fd2 = jQuery.extend({}, form_data);

        if (keep_vars_on_back != 1)
            form_data_history.push(fd2);


// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// get the search text from the current node form, and place it into the search term slot

        search_text = $(idnode + hide + " #zt-tree-search input[name='keywords']").val();
        $("#node1004 #searchterm").text(search_text);

        button_text_history.push("Tree Search: " + search_text + '<br>');


// make a list of trees that have the title or tags

        var request2 = $.ajax({
            url: tree_find_url,
            method: "POST",
            data: {op: 'find_trees', tree_id: master_tree_id, apikey: '80fbc7272d1c3597f70e95be05eebda9', search: search_text},
            async: true,
            dataType: "html",
            uid: uid
        });

        request2.done(function (msg) {
            log(msg);

            if (msg[0] == '*')
                alert(msg);
            else {

                // add JSON result to form_data
                // refresh the display after we receive data (if we receive any data)

                var json = JSON.parse(msg);
                var results = '';

                var i;
                for (i = 0; i < json.count; ++i) {

                    // hack for single quotes
                    name2 = json.results[i].name;
                    name2 = name2.replace('^^', "'");
                    name2 = name2.replace('^^', "'");

                    name2 = name2.replace("'", "&quot;");
                    name2 = name2.replace("'", "&quot;");
                    name2 = name2.replace("&#039;", "&quot;");


                    results = results + '<li><a onmouseover="" style="cursor: pointer;" onclick="do_tree_click(' + json.results[i].tree_id + ', \'' + name2 + '\', 0) ; ">' + json.results[i].name + '</a></li>';
                }

                // insert the search results into the search results node
                $("#node1004 #searchresults").html(results);

                refresh_display();


            }

        });


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


        
// async log the button click event

        ++click_num;   // keep click events in sync

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: hide,
                to: this_node_id,
                click_text: 'Tree Search: ' + search_text,
                resolution_state: '?',
                form_data: form_data_string,
                instance: "6",
                click_num: click_num
            },
            async: true,
            dataType: "html",
            uid: uid

        });

        request.done(function (msg) {
            log(msg);

        });

        
        return (false);    // return false to ensure form is not actually submitted

    }


    // search all non-hidden trees for content
    // results point to the tree and node with matching content
    // this is the first part, which handles the fade effect

    function do_search_linked_trees() {

        // fade out the current node before entering the restart process

        if (transition == 'fade') {

            // fade out normal nodes

            if (this_node_id < 1000) {

                // wait until fadeOut completes, then complete do_search_trees_go()
                $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_linked_trees_go();
                });
            }

            // fade out special search nodes

            else {
                // wait until fadeOut completes, then complete do_search_trees()
                $('#node' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_linked_trees_go();
                });
            }


            return;

        }


        // jump into tree search handler

        do_search_linked_trees_go();
    }


    // results point to the tree and node with matching content
    // searches just within trees linked to the current tree (and including the current tree)

    function do_search_linked_trees_go() {
        var idnode = '#node-' + this_tree_id + '-';

// hide the current node
        hide = button_history[button_history.length - 1];

// show search results node

        this_node_id = 1004;
        button_history.push(this_node_id);
        tree_history.push(this_tree_id);

        fd2 = jQuery.extend({}, form_data);

        if (keep_vars_on_back != 1)
            form_data_history.push(fd2);


// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// get the search text from the current node form, and place it into the search term slot

        search_text = $(idnode + hide + " #zt-tree-search input[name='keywords']").val();
        $("#node1004 #searchterm").text(search_text);

        button_text_history.push("Tree Search: " + search_text + '<br>');


// make a list of trees that have the title or tags

        var request2 = $.ajax({
            url: tree_find_url,
            method: "POST",
            data: {op: 'search_linked_trees', apikey: '80fbc7272d1c3597f70e95be05eebda9', search: search_text, tree_id: master_tree_id},
            async: true,
            dataType: "html",
            uid: uid
        });

        request2.done(function (msg) {
            log(msg);

            if (msg[0] == '*')
                alert(msg);
            else {

                // add JSON result to form_data
                // refresh the display after we receive data (if we receive any data)

                var json = JSON.parse(msg);
                var results = '';

                var i;
                for (i = 0; i < json.count; ++i) {
                    if (
                        (json.results[i].search_scope == 0) || 								// everything
                        ((json.results[i].search_scope == 1) && (agent_mode == 1)) || 		// agent-only nodes
                        ((json.results[i].search_scope == 2) && (agent_mode == 0))			// user-only nodes
                    ) {

                        // hack for single quotes
                        name2 = json.results[i].name;
                        name2 = name2.replace('^^', "&quot;");
                        name2 = name2.replace('^^', "&quot;");

                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("&#039;", "&quot;");


                        results = results + '<li><a onmouseover="" style="cursor: pointer;" onclick="do_tree_click(' + json.results[i].tree_id + ', \'' + name2 + '\', ' + json.results[i].node + ') ; ">' + json.results[i].name + ': ' + json.results[i].page_title + '</a></li>';
                    }
                }

                // insert the search results into the search results node
                $("#node1004 #searchresults").html(results);

                refresh_display();


            }

        });


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


        
// async log the button click event

        ++click_num;   // keep click events in sync

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: hide,
                to: this_node_id,
                click_text: 'Tree Content Search: ' + search_text,
                resolution_state: '?',
                form_data: form_data_string,
                instance: "6",
                click_num: click_num
            },
            async: true,
            dataType: "html",
            uid: uid

        });

        request.done(function (msg) {
            log(msg);

        });

        
        return (false);    // return false to ensure form is not actually submitted

    }


    // search all non-hidden trees for content in title and tags only
    // results point to the tree and node with matching content
    // this is the first part, which handles the fade effect

    function do_search_linked_trees_title_tags() {

        // fade out the current node before entering the restart process

        if (transition == 'fade') {

            // fade out normal nodes

            if (this_node_id < 1000) {

                // wait until fadeOut completes, then complete do_search_trees_go()
                $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_linked_trees_title_tags_go();
                });
            }

            // fade out special search nodes

            else {
                // wait until fadeOut completes, then complete do_search_trees()
                $('#node' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_linked_trees_title_tags_go();
                });
            }


            return;

        }


        // jump into tree search handler

        do_search_linked_trees_title_tags_go();
    }


    // results point to the tree and node with matching content
    // searches just title and tags within trees linked to the current tree (and including the current tree)

    function do_search_linked_trees_title_tags_go() {
        var idnode = '#node-' + this_tree_id + '-';

// hide the current node
        hide = button_history[button_history.length - 1];

// show search results node

        this_node_id = 1004;
        button_history.push(this_node_id);
        tree_history.push(this_tree_id);

        fd2 = jQuery.extend({}, form_data);

        if (keep_vars_on_back != 1)
            form_data_history.push(fd2);


// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// get the search text from the current node form, and place it into the search term slot

        search_text = $(idnode + hide + " #zt-tree-search input[name='keywords']").val();
        $("#node1004 #searchterm").text(search_text);

        button_text_history.push("Tree Search: " + search_text + '<br>');


// make a list of trees that have the title or tags

        var request2 = $.ajax({
            url: tree_find_url,
            method: "POST",
            data: {op: 'search_linked_trees_title_tags', apikey: '80fbc7272d1c3597f70e95be05eebda9', search: search_text, tree_id: master_tree_id},
            async: true,
            dataType: "html",
            uid: uid
        });

        request2.done(function (msg) {
            log(msg);

            if (msg[0] == '*')
                alert(msg);
            else {

                // add JSON result to form_data
                // refresh the display after we receive data (if we receive any data)

                var json = JSON.parse(msg);
                var results = '';

                var i;
                for (i = 0; i < json.count; ++i) {
                    // ensure user-only or agent-only searches exclude unwanted results
                    if (
                        (json.results[i].search_scope == 0) || 								// everything
                        ((json.results[i].search_scope == 1) && (agent_mode == 1)) || 		// agent-only nodes
                        ((json.results[i].search_scope == 2) && (agent_mode == 0))			// user-only nodes
                    ) {

                        // hack for single quotes
                        name2 = json.results[i].name;
                        name2 = name2.replace('^^', "&quot;");
                        name2 = name2.replace('^^', "&quot;");

                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("&#039;", "&quot;");


                        results = results + '<li><a onmouseover="" style="cursor: pointer;" onclick="do_tree_click(' + json.results[i].tree_id + ', \'' + name2 + '\', ' + json.results[i].node + ') ; ">' + json.results[i].name + ': ' + json.results[i].page_title + '</a></li>';
                    }
                }

                // insert the search results into the search results node
                $("#node1004 #searchresults").html(results);

                refresh_display();


            }

        });


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


        
// async log the button click event

        ++click_num;   // keep click events in sync

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: hide,
                to: this_node_id,
                click_text: 'Tree Title and Tags Search: ' + search_text,
                resolution_state: '?',
                form_data: form_data_string,
                instance: "6",
                click_num: click_num
            },
            async: true,
            dataType: "html",
            uid: uid

        });

        request.done(function (msg) {
            log(msg);

        });

        
        return (false);    // return false to ensure form is not actually submitted

    }


    // search all non-hidden trees for content
    // results point to the tree and node with matching content
    // this is the first part, which handles the fade effect

    function do_search_trees() {

        // fade out the current node before entering the restart process

        if (transition == 'fade') {

            // fade out normal nodes

            if (this_node_id < 1000) {

                // wait until fadeOut completes, then complete do_search_trees_go()
                $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_trees_go();
                });
            }

            // fade out special search nodes

            else {
                // wait until fadeOut completes, then complete do_search_trees()
                $('#node' + this_node_id).fadeOut(transition_duration, function () {
                    do_search_trees_go();
                });
            }


            return;

        }


        // jump into tree search handler

        do_search_trees_go();
    }


    // search all non-hidden trees for content
    // results point to the tree and node with matching content

    function do_search_trees_go() {
        var idnode = '#node-' + this_tree_id + '-';

// hide the current node
        hide = button_history[button_history.length - 1];

// show search results node

        this_node_id = 1004;
        button_history.push(this_node_id);
        tree_history.push(this_tree_id);

        fd2 = jQuery.extend({}, form_data);

        if (keep_vars_on_back != 1)
            form_data_history.push(fd2);


// let the parent window know we've changed the current node

        parent.postMessage("Node=" + this_node_id, "*");
        parent.postMessage("Tree=" + this_tree_id, "*");
        emitEvent("nodeTransition", {
            treeId: this_tree_id,
            toNodeId: this_node_id
        });


// get the search text from the current node form, and place it into the search term slot

        search_text = $(idnode + hide + " #zt-tree-search input[name='keywords']").val();
        $("#node1004 #searchterm").text(search_text);

        button_text_history.push("Tree Search: " + search_text + '<br>');


// make a list of trees that have the title or tags

        var request2 = $.ajax({
            url: tree_find_url,
            method: "POST",
            data: {op: 'search_trees', tree_id: master_tree_id, apikey: '80fbc7272d1c3597f70e95be05eebda9', search: search_text},
            async: true,
            dataType: "html",
            uid: uid
        });

        request2.done(function (msg) {
            log(msg);

            if (msg[0] == '*')
                alert(msg);
            else {

                // add JSON result to form_data
                // refresh the display after we receive data (if we receive any data)

                var json = JSON.parse(msg);
                var results = '';

                var i;
                for (i = 0; i < json.count; ++i) {
                    if (
                        (json.results[i].search_scope == 0) || 								// everything
                        ((json.results[i].search_scope == 1) && (agent_mode == 1)) || 		// agent-only nodes
                        ((json.results[i].search_scope == 2) && (agent_mode == 0))			// user-only nodes
                    ) {

                        // hack for single quotes
                        name2 = json.results[i].name;
                        name2 = name2.replace('^^', "&quot;");
                        name2 = name2.replace('^^', "&quot;");

                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("'", "&quot;");
                        name2 = name2.replace("&#039;", "&quot;");


                        results = results + '<li><a onmouseover="" style="cursor: pointer;" onclick="do_tree_click(' + json.results[i].tree_id + ', \'' + name2 + '\', ' + json.results[i].node + ') ; ">' + json.results[i].name + ': ' + json.results[i].page_title + '</a></li>';
                    }
                }

                // insert the search results into the search results node
                $("#node1004 #searchresults").html(results);

                refresh_display();


            }

        });


// if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

        fix_scroll();


// make the form data as a string to send to tracker

        form_data_string = make_form_data_string(form_data);
        emitEvent('sessionReported');


        
// async log the button click event

        ++click_num;   // keep click events in sync

        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: hide,
                to: this_node_id,
                click_text: 'Tree Content Search: ' + search_text,
                resolution_state: '?',
                form_data: form_data_string,
                instance: "6",
                click_num: click_num
            },
            async: true,
            dataType: "html",
            uid: uid

        });

        request.done(function (msg) {
            log(msg);

        });

        
        return (false);    // return false to ensure form is not actually submitted

    }


    // this gets called from tree search results to open a new tree
    // called from UI


    function do_tree_click(tree_id, tree_name, start_node) {

        // fade out the current node before entering the restart process

        if (transition == 'fade') {

            // fade out normal nodes

            if (this_node_id < 1000) {

                // wait until fadeOut completes, then complete do_tree_click()
                $('#node-' + this_tree_id + '-' + this_node_id).fadeOut(transition_duration, function () {
                    do_tree_click_go(tree_id, tree_name, start_node);
                });
            }

            // fade out special search nodes

            else {
                // wait until fadeOut completes, then complete do_tree_click()
                $('#node' + this_node_id).fadeOut(transition_duration, function () {
                    do_tree_click_go(tree_id, tree_name, start_node);
                });
            }


            return;

        }


        // jump into tree click handler

        do_tree_click_go(tree_id, tree_name, start_node);
    }


    // opens a new tree
    // if start_node == 0, starts at root node

    function do_tree_click_go(tree_id, tree_name, start_node) {
        last_node_id = 1004;

        tree_name.replace('^^', "'"); // hack for single quotes issue
        tree_name.replace('^^', "'");

        button_text_history.push('<span class="zt-history-answer">' + tree_name + ' </span><br>');
        load_tree(tree_id, "launch", start_node);
    }


    // **** event listener
    // react to events posted from containing window

    // listen for "back" or "restart" events from hosting window

    function messageListener(event) {
        if (debug_mode) console.log("messageListener: received message for session " + session_id + ": ", event);
        var eventData = event.data;
        if (typeof event.data == 'string' && event.data.substr(0,1) == '{') {
            try {
                eventData = JSON.parse(event.data);
            } catch (e) {
                eventData = event.data;
            }
        }
        if (Object.prototype.toString.call(eventData) === '[object Object]') {
            if (eventData.event && eventData.zingtree_session == session_id) {
                if (debug_mode) console.log("messageListener: received event: ", eventData);
                emitEvent('externalEvent', { 'event': eventData.event, 'data': eventData.data });
                emitEvent('externalEvent:' + eventData.event, { 'event': eventData.event, 'data': eventData.data });
            }
        }

        if (event.data == "back")
            go_back();

        if (event.data == "restart")
            restart('Restart');

        // toggle content area
        if (event.data == "toggle_content") {
            $(".content-question").toggle();
            $(".content-answer").toggle();
        }
    }


    // set up the event listener

    if (window.addEventListener)
        addEventListener("message", messageListener, false);
    else
        attachEvent("onmessage", messageListener);


    // enable buttons when we click a confirmation checkbox

    function enable_buttons(idnodeid) {
        $(idnodeid + ' .btn-zingtree').removeClass('disabled');
        $(idnodeid + ' .btn-zingtree').removeClass('ztdisabled');

        // keep box in checked state once checked (no toggle)
        $(idnodeid + '-box').prop('checked', true);
    }


    function escapeRegExp(str) {
        return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
    }


    // when jumping trees, keep track of the stack of trees

    function push_tree_launch_history(tree_id, return_node_id) {
        tree_launch_history.push(tree_id);
        tree_launch_return_node_history.push(return_node_id);
    }


    // **** load tree

    // load a tree with ID=tree_id
    // perform action at end of load: can be "init", "launch", or ""
    // if start_node != 0, start new tree from new_start_node

    function load_tree(tree_id, action, new_start_node) {

        // show agent alert if it exists

        var alert_tree_list = [] ;   // list of trees which may have an alert for the agent (eliminates most unneeded get-agent-alert.php calls)

        if ((agent_mode == 1) && (alert_tree_list.indexOf (Number(tree_id)) != -1) && (typeof trees[tree_id] === 'undefined')) {
            var request = $.ajax({
                url: agent_alert_url,
                method: "POST",
                data: {source: source, tree_id: this_tree_id},
                async: true,
                dataType: "html",
                uid: uid
            });

            request.done(function (msg) {
                if (msg != '')
                    alert("AGENT ALERT\n" + msg);
            });
        }


// if tree already loaded from JSON, don't load it again

        if (typeof trees[tree_id] !== 'undefined') {

            if (action == "launch") {

                // set the new current tree
                this_tree_id = tree_id;

                // start from the root, or the passed-in start node if not zero
                if (new_start_node == 0)
                    this_node_id = trees[tree_id].root_node_id;
                else
                    this_node_id = new_start_node;

                // tell preview edit node buttons we have a new node and tree ID
                parent.postMessage("Tree=" + this_tree_id, "*");
                parent.postMessage("Node=" + this_node_id, "*");
                parent.postMessage("Treename=" + trees[this_tree_id].name, "*");
                emitEvent("nodeTransition", {
                    treeId: this_tree_id,
                    toNodeId: this_node_id
                });

                
                

                // save new node in history
                // other stack items are already done in do_button_click()

                button_history.push(this_node_id);
                tree_history.push(this_tree_id);


                // update form data string in case a webhook is called

                form_data_string = make_form_data_string(form_data);


                // send app messages contained in start node of loaded tree

                if (typeof trees[this_tree_id].nodes[this_node_id] === 'undefined') {
                    alert("Warning: Node #" + this_node_id + " does not exist in tree #" + this_tree_id + ". Unable to continue.");
                } else {

                    form_changes = {};
                    for (var i = 0; i < 10; ++i) {
                        if (typeof trees[this_tree_id].nodes[this_node_id].app_messages[i] === 'undefined')
                            break;

                        //       alert (trees[this_tree_id].nodes[show].app_messages[i].app + ': ' + trees[this_tree_id].nodes[show].app_messages[i].message) ;

                        var request2 = $.ajax({
                            url: app_message_url,
                            method: "POST",
                            data: {
                                master_tree_id: master_tree_id,
                                tree_id: this_tree_id,
                                session_id: session_id,
                                app: trees[this_tree_id].nodes[this_node_id].app_messages[i].app,
                                app_id: trees[this_tree_id].nodes[this_node_id].app_messages[i].app_id,
                                message: trees[this_tree_id].nodes[this_node_id].app_messages[i].message,
                                form_data: form_data_string, source: source,
                                node_number: this_node_id,
                                from_node_number: 0,
                                auth_token: auth_token,
                                sf_id: ''
                            },
                            async: true,
                            dataType: "html",
                            uid: uid
                        });

                        request2.done(function (msg) {
                            log(msg);

                            if (msg[0] == '*')
                                alert(msg);
                            else {

                                // add JSON result to form_data
                                // refresh the display after we receive data (if we receive any data)

                                try {
                                    var json = JSON.parse(msg);

                                    var do_refresh = 0;
                                    for (var key in json) {
                                        // ensure webhook results are not arrays
                                        if (Array.isArray(json[key]) === false) {
                                            // turn NULL values into empty strings

                                            if (json[key] == null)
                                                json[key] = '';

                                            // add new variable to form data
                                            form_changes[key] = form_data[key] = json[key];
                                            do_refresh = 1;
                                        }
                                    }

                                    if (do_refresh == 1)
                                        refresh_display();
                                } catch (e) {
                                }
                            }

                        });


                    }
                    emitEvent('webhooksComplete', form_changes);

                }

                // handle scoring or A/B test nodes as root of launched tree node

                if (trees[this_tree_id].nodes[this_node_id].type == "Scoring") {
                    do_logic_jump(this_node_id);
                    return;
                }


                // show the latest node and history

                refresh_display();


                // if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

                fix_scroll();


                // make the form data as a string to send to tracker

                form_data_string = make_form_data_string(form_data);
                emitEvent('sessionReported');


// get the resolution state for the starting node

                var resolution_state = trees[this_tree_id].nodes[this_node_id].resolution_state;
                signalResolution(resolution_state);

                
                set_escalation(60 * trees[this_tree_id].nodes[this_node_id].escalate_after);


                // async log the button click event (except for Gallery?)

                ++click_num;   // keep click events in sync

                // use name of tree as button text if we don't have anything here
                if (typeof last_button_text === 'undefined')
                    last_button_text = trees[this_tree_id].name;

                set_escalation(60 * trees[this_tree_id].nodes[this_node_id].escalate_after);

                var request = $.ajax({
                    url: tracking_url,
                    method: "POST",
                    data: {
                        source: source,
                        agent_mode: agent_mode,
                        tree_id: trees[this_tree_id].tree_id,
                        master_tree_id: master_tree_id,
                        session_id: session_id,
                        from: last_node_id,
                        to: this_node_id,
                        click_text: last_button_text,
                        resolution_state: resolution_state,
                        form_data: form_data_string,
                        instance: "7",
                        click_num: click_num,
                        tag: trees[this_tree_id].nodes[this_node_id].tag,
                        escalate_after: trees[this_tree_id].nodes[this_node_id].escalate_after
                    },
                    async: true,
                    dataType: "html",
                    uid: uid
                });

                request.done(function (msg) {
                    log(msg);

                });

                
            } else if (action == "redraw") {
                refresh_display();
            }

            return;
        }

// load the tree and add to the DOM
// uid is the current time in seconds, and ensures that the JSON data is not cached by the browser. This makes Preview and any changes take effect immediately.

        trees[tree_id] = 0; // prevents reloading tree




        
// function to render an individual data entry form field

function render_formfield(node_id, ff_type, ff_name, ff_value, ff_label, ff_options, ff_required, ff_score_var, ff_scores, ff_regex, ff_inline, ff_checkbox_score, ff_label_type, ff_index, form_columns)
{

// if we have multiple fields, add an index to the end of each

    if (ff_index != 0)
        ff_name += '_'+ff_index ;


    // add hidden field for hidden field type
    // don't need to do any formatting or rendering

    if (ff_type == 'hidden')
    {
        result = '<input class="zt-data" type="hidden" name="'+ff_name+'" id="'+ff_name+'" value="' + ff_value+'">' ;
        return (result) ;

    }


    result = '' ;


    // style tweak ensures required marker is on same line as input control
//    result += '<style>.form-control.zt-data {display:initial !important;}</style>' ;


    result += '<div class="row">' ;

    if (ff_required == 1)
    {
        mark = '<span class="text-danger">*</span>' ;   // add red asterisk to required fields
        req = 'req' ;                                   // and attribute in input control
    }
    else
    {
        mark = '<span class="text-danger">&nbsp;</span>' ;
        req = '' ;
    }

// how much to reposition Verify badge - default to no reposition (for placeholder type)

    var verify_badge_reposition = '' ;

    if (ff_label_type == 'L')
        verify_badge_reposition = 'margin: 6px 0 0 0;' ;
    else
        verify_badge_reposition = 'margin: -30px 0 0 0;' ;


// start of form field div
// size for different control types

	// single column forms

	if (form_columns == 1)
	{
		if ((ff_type == 'radio') || (ff_type == 'multiline_full'))
			result += '<div class="col-md-12 col-sm-12">' ;

		else if (ff_type == 'email')
			result += '<div class="col-md-6 col-sm-8 col-xs-12">' ;

		else if (ff_type == 'zip')
			result += '<div class="col-md-3 col-sm-6 col-xs-12">' ;

		else if (ff_type == 'phone')
			result += '<div class="col-md-3 col-sm-6 col-xs-12">' ;

		else
			result += '<div class="col-md-6 col-sm-12">' ;
	}

// 2 column forms
	else
	{
		if ((ff_type == 'radio') || (ff_type == 'multiline_full'))
			result += '<div class="col-md-10 col-sm-12">' ;

		else if (ff_type == 'email')
			result += '<div class="col-md-8 col-sm-8 col-xs-12">' ;

		else if (ff_type == 'zip')
			result += '<div class="col-md-6 col-sm-6 col-xs-12">' ;

		else if (ff_type == 'phone')
			result += '<div class="col-md-6 col-sm-6 col-xs-12">' ;

		else
			result += '<div class="col-md-8 col-sm-12">' ;

	}

    // add form-inline for inline radio buttons
    if ((ff_type == 'radio') && (ff_inline == 1))
        result += '<div class="form-group form-inline">' ;
    else
        result += '<div class="form-group">' ;




    if ((ff_type == 'file') || (ff_type == 'tempfile'))
    {

    // add hidden field for uploaded file URL
    // this will be filled in by upload button/form outside of main form

        h = '<input class="zt-data" type="hidden" name="'+ff_name+'" id="'+ff_name+'">' ;
        result += h ;

    }


    if (ff_type == 'text')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;
        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }


    if (ff_type == 'address1')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-address1" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;
        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-address1" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;

        }
    }

    if (ff_type == 'address2')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-address2" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;
        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-address2" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;

        }
    }

    if (ff_type == 'city')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-city" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;
        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-city" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;

        }
    }

    if (ff_type == 'state')
    {

        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-state" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;
        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-state" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;

        }

    }



    if (ff_type == 'zip')
    {

        if (ff_label_type == 'L')
        {

            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-zip" type="' + ff_type + '" name="' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + '>' ;

        }

        // use placeholder instead of label

        else
        {
            result += '<div class="form-inline" >' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;

            result += '<input class="form-control zt-data zt-data-zip" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" id="' + ff_name + '" '+ req + ' placeholder="' + ff_label + '"> ' ;

            result += '</div>' ;

        }

    }




    if ((ff_type == 'multiline') || (ff_type == 'multiline_full'))
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<textarea class="form-control zt-data" type="' + ff_type + '" name = "' + ff_name + '" ' + req + ' >' + ff_value + '</textarea>' ;
        }

        // use placeholder instead of label
        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<textarea class="form-control zt-data" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" placeholder="' + ff_label + '" ' + req + '>' + ff_value + '</textarea>' ;
            result += '</div>' ;

        }
    }



// custom types - includes special class for custom validation
// add a regex attribute to the field -- this is the regex used for validating the field

    if (ff_type == 'custom')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input regex="'+ ff_regex +'" class="form-control zt-data zt-data-custom" type="text" name = "' + ff_name + '" value="' + ff_value + '" '+ req + '>' ;
        }

        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input regex="'+ ff_regex +'" class="form-control zt-data zt-data-custom" style="width: 95%;" type="text" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }

// email types - includes special class for email verification

    if (ff_type == 'email')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-email" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" '+ req + '>' ;
        }

        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-email" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }


// phone types - includes special class for phone number verification

    if (ff_type == 'phone')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-phone" type="tel" name = "' + ff_name + '" value="' + ff_value + '" '+ req + '>' ;
        }

        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data zt-data-phone" style="width: 95%;" type="tel" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }





    if ( (ff_type == 'number') || (ff_type == 'password'))
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" '+ req + '>' ;
        }

        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data" style="width: 95%;" type="' + ff_type + '" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }


    if (ff_type == 'date')
    {
        if (ff_label_type == 'L')
        {
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
            result += '<input class="form-control zt-data datepicker" type="text" name = "' + ff_name + '" value="' + ff_value + '" '+ req + '>' ;
        }
        else
        {
            result += '<div class="form-inline">' ;
            result += '<label for="' + ff_name + '" class="control-label">' + mark + ' </label>\n' ;
            result += '<input class="form-control zt-data datepicker" style="width: 95%;" type="text" name = "' + ff_name + '" value="' + ff_value + '" '+ req + ' placeholder="' + ff_label + '">' ;
            result += '</div>' ;
        }
    }



    if (ff_type == 'checkbox')
    {

    // add scoring info for checkbox if it has a score var

        var checked = '' ;
        if (ff_value == 1)
            checked = ' checked' ;


        var cb_score ;
        if (ff_score_var != '')
            cb_score = ' score_var="' + ff_score_var + '" score="' + ff_checkbox_score + '" ' ;
        else
            cb_score = '' ;

        result += '<div class="checkbox">' ;
        result += '<label><input type="checkbox" value="1" ' + cb_score + ' class="zt-data" name="' + ff_name + '"' + checked + ' > ' + ff_label + ' </label>\n' ;
        result += '</div>' ;
    }


    // init for list box, radio buttons
    var option_list = '' ;

    // get list of score values  - these are separated by newlines
    scores = ff_scores.split("\n") ;

    // set score_var tag if we have a non-blank score var
    if (ff_score_var != '')
        score_var = 'score_var="' + ff_score_var + '" ' ;
    else
        score_var = '' ;


    // List box
    if (ff_type == 'select')
    {

        result += '<label for="' + ff_name + '" class="control-label">' + mark + ff_label + ' </label>\n' ;
        result += '<select class="form-control zt-data" name = "' + ff_name + '" ' + score_var + req + '>' ;

        i = 0 ;
        option_list = '' ;

        // blank items trigger "required" action
        if (ff_required == 1) {
            option_list += '<option value=""></option>';
        }

        ff_options.split('\n').forEach(function(item){
            if (item != '')
            {
                item = item.replace ("\r", "") ;
                item = item.trim() ;
                var selected = '' ;
                if (item == ff_value)
                    selected = ' selected' ;

                if (typeof scores[i] === 'undefined')
                    option_list += '<option value="'+ item + '"' + selected + '>' + item + '</option>';
                else
                {
                    score = scores[i].replace ("\r", "") ;
                    option_list += '<option score="' + score + '" value="'+ item + '"' + selected + '>' + item + '</option>';

                }

            }
            ++i ;

        } ) ;

        result += option_list ;
        result += '</select>' ;
    }


    // Radio buttons
    if (ff_type == 'radio')
    {
        result += mark + ff_label ;

        option_list = '' ;
        i = 0 ;

        // inline radio buttons get a couple of spaces to separate items
        var sep1 = '' ;
        var sep2 = '' ;
        if (ff_inline == 1)
        {
            sep1 = '&nbsp; ' ;
            sep2 = ' ' ;
        }
        else
            result += '<br>' ;

        ff_options.split('\n').forEach(function(item){

            item = item.replace ("\r", "") ;
            item = item.trim() ;

            if (item != '')
            {

                if (typeof scores[i] === 'undefined')
                    score = '0' ;
                else
                    score = scores[i].replace ("\r", "") ;

                var select_me = '' ;
                if (item == ff_value)
                    select_me = ' checked ' ;

                option_list += sep1 + '<div class="radio"><label for="' + ff_name + '">' ;
                option_list += sep2 + '<input class="zt-data" type="radio" name="' + ff_name + '" value="' + item + '" ' + score_var + ' ' + select_me + ' score="' + score + '" ' + req + '>&nbsp;'+item ;
                option_list += '</label></div>' ;
            }
            ++i ;

        } ) ;

        result += option_list ;
    }


// end of form field div

    result += '</div>' ;
    result += '</div>' ;

// add verification badge to right side of ZIP field

    if (ff_type == 'zip')
    {
		if (form_columns == 1)
	        result += '<div class="col-md-3 col-sm-6 col-xs-6">' ;
		else
	        result += '<div class="col-md-5 col-sm-6 col-xs-6">' ;

        result += '<div class="zt-verified" style="display:none;' + verify_badge_reposition + '">' ;
        result += '<br>' ;
        result += ' <span class="btn btn-sm btn-success"><i class="fa fa-check" aria-hidden="true"></i> USPS Verified</span>' ;
        result += '</div>' ;
        result += '</div>' ;

    }

// add quality score badges to right side of email field
// these all start hidden

    if (ff_type == 'email')
    {
		if (form_columns == 1)
	        result += '<div class="col-md-3 col-sm-4 col-xs-4">' ;
		else
	        result += '<div class="col-md-4 col-sm-4 col-xs-4">' ;

        result += '<br>' ;
        result += '<div class="'+ff_name+'-msg">' ;
        result += ' <span id="zt-email-quality-high" class="zt-email-quality-high btn btn-sm btn-success" style="display:none;' + verify_badge_reposition + '" data-toggle="tooltip" data-placement="top" title="Email address verified by email server"><i class="fa fa-check" aria-hidden="true"></i> High Quality</span>' ;
        result += ' <span id="zt-email-quality-medium" class="zt-email-quality-medium btn btn-sm btn-orange" style="display:none;' + verify_badge_reposition + '" data-toggle="tooltip" data-placement="top" title="Email probably valid. Email server did not give a definitive answer."><i class="fa fa-check" aria-hidden="true"></i> Probably OK</span>' ;
        result += ' <span id="zt-email-quality-low" class="zt-email-quality-low btn btn-sm btn-danger" style="display:none;' + verify_badge_reposition + '" data-toggle="tooltip" data-placement="top" title="Could not verify email by contacting email server"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Unverified</span>' ;

        result += ' <span id="zt-email-invalid-format" class="zt-email-invalid-format btn btn-sm btn-danger" data-toggle="tooltip" data-placement="top" title="What you entered does not look like an email address." style="display:none;' + verify_badge_reposition + '"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Bad Format</span>' ;
        result += '</div>' ;
        result += '</div>' ;

    }


// add "Valid" and "not Valid" badges to right side of phone field
// these both start hidden

    if (ff_type == 'phone')
    {
        result += '<div class="col-md-3 col-sm-4 col-xs-4">' ;
        result += '<br>' ;
        result += '<div class="'+ff_name+'-msg">' ;

        result += ' <span id="zt-phone-verified" class="zt-phone-verified btn btn-sm btn-success" style="display:none;' + verify_badge_reposition + '" data-toggle="tooltip" data-placement="top" title="Tooltip"><i class="fa fa-check" aria-hidden="true"></i> Validated</span>' ;
        result += ' <span id="zt-phone-not-verified" class="zt-phone-not-verified btn btn-sm btn-danger" style="display:none;' + verify_badge_reposition + '" data-toggle="tooltip" data-placement="top" title="Tooltip"><i class="fa fa-exclamation-circle" aria-hidden="true"></i> Not Validated</span>' ;
        result += '</div>' ;
        result += '</div>' ;

    }


    result += '</div>' ;    // end row div

    return (result) ;

}
        $("#link-wait").show();
        $.getJSON("/api/json.php?tree_id=" + tree_id + "&agent_mode=0&uid=1617349835", function (tree) {
            $("#link-wait").hide();

            log(tree);

            trees[tree_id] = tree;

            // node IDs, local to load_tree()
            var idnode = '#node-' + tree_id + '-';
            var idnode0 = 'node-' + tree_id + '-';     // same as idnode, without the #

            emitEvent('render:start', {
                treeId: tree_id,
                treeDefinition: tree
            })

            // set the title and description

            $('#title').html(tree.name);
            $('.zt_title').html(tree.name);    // for hosting frame

            
            

            $('#description').html(tree.description);

            var nodes = tree.nodes;

            // create each node from the hidden template
            // nodes start as hidden
            // each node is IDed with the project node id so we can tell them apart

            address_map = new Array();

            $.each(nodes, function (i, node) {
                log("Loading Node #" + i);

                var parent = (window.location != window.parent.location)
                    ? document.referrer
                    : document.location;

                id = node.project_node_id;

                // save a copy of the title without permalink mods
                node.page_title_plain = node.page_title;

                // add a permalink to the title if a permalink is passed in
                
                if (node.allow_pdf_download == 1) {
                    if (zt_style == "panels")
                        node.page_title += '<span class="pull-right"><a download class="btn btn-default btn-sm" onmouseover="" style="cursor: pointer; margin-top: -26px;" onclick="download_pdf();" data-toggle="tooltip" data-placement="top" title="Download this page as a PDF document file"><i class="fa fa-download" aria-hidden="true"></i>&nbsp;Download PDF</a></span>';
                    else
                        node.page_title += '<span class="pull-right"><a download class="btn btn-primary btn-zingtree btn-sm" onmouseover="" style="cursor: pointer;" onclick="download_pdf();" data-toggle="tooltip" data-placement="top" title="Download this page as a PDF document file"><i class="fa fa-download" aria-hidden="true"></i>&nbsp;Download PDF</a></span>';
                } else if (node.allow_pdf_download == 2) {
                    if (zt_style == "panels")
                        node.page_title += '<span class="pull-right"><a class="btn btn-default btn-sm" onmouseover="" style="cursor: pointer; margin-top: -26px;" onclick="download_html();" data-toggle="tooltip" data-placement="top" title="Download this page as an HTML file"><i class="fa fa-download" aria-hidden="true"></i>&nbsp;Download HTML File</a></span>';
                    else
                        node.page_title += '<span class="pull-right"><a class="btn btn-primary btn-zingtree btn-sm" onmouseover="" style="cursor: pointer;" onclick="download_html();" data-toggle="tooltip" data-placement="top" title="Download this page as an HTML file"><i class="fa fa-download" aria-hidden="true"></i>&nbsp;Download HTML File</a></span>';
                }


                


                // ************* DOCUMENT NODES

                // just make a placeholder for adding snippets later

                if (node.type == "Document") {

                    
                    if (zt_style == "panels")
                        node_html = $("#panelnode0").html(); // use prototype from inside this document
                    else
                        node_html = $("#buttonnode0").html(); // use prototype from inside this document

                    id = node.project_node_id;

                    node_html = '<div style="display:none; " class="zingtree-node" id="' + idnode0 + node.project_node_id + '">' + node_html + '</div>';
                    $("#nodes").append(node_html);

                    // replace variables in node title with class marker

                    node.page_title = node.page_title.replace(/#(\w|-)+#/g, vreplace);

                    // replace merge variables in page title now

                    $.each(zt_vars, function (i, zt_var) {
                        var re = new RegExp(escapeRegExp('#' + zt_var + '#'), "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one
                        node.page_title = node.page_title.replace(re, '<span class="ztvar-'+zt_var+'">'+zt_vals[i]+'</span>');
                    });


                    // set up an area where we can insert parts of generated document

                    node.content = '<div class="document-node" id="document-node-' + id + '"></div>';

                    // add Continue button if requested

                    if (node.continuation_node_id != 0) {
                        node.content += '<br><div align="center"><a onclick="do_button_click(' + node.continuation_node_id + ', ' + id + ', \'' + node.continuation_button_text + '\', 0, \'\'); " class="more btn btn-primary btn-zingtree">' + node.continuation_button_text + '</a></div>';
                    }

                    $(idnode + id + " #node-content").html(node.content);
                    $(idnode + id + " #node-title").html(node.page_title);

                    
                }


                // replacer function used to make classes from #variable# markup
                function vreplace(v) {
                    v2 = v.slice(1, -1);    // remove first and last # characters
                    return ('<span class="ztvar-' + v2 + '">' + v + '</span>');
                }


                // ************* CONTENT NODES

                if (node.type == "Content") {

                    // replace merge variables

                    $.each(zt_vars, function (i, zt_var) {

                        var re = new RegExp(escapeRegExp('#' + zt_var + '#'), "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                        node.question = node.question.replace(re, '<span class="ztvar-'+zt_var+'">'+zt_vals[i]+'</span>');
                        node.page_title = node.page_title.replace(re, '<span class="ztvar-'+zt_var+'">'+zt_vals[i]+'</span>');

                        // substitute merge vars with values right now, unless they can change via a form or webhook
                        if (merge_vars_not_fixed == 0)
                            node.content = node.content.replace(re, '<span class="ztvar-'+zt_var+'">'+zt_vals[i]+'</span>');


                    });

                    // add <!= NOMACROS --> to content body to disable expansion of stock macros

                    if (-1 == node.content.indexOf("NOMACROS")) {

                        // replace #score# with span to insert score dynamically

                        node.content = node.content.replace('#score#', '<span id="zt_score"></span>');

                        // current agent login and agent name
                        node.content = node.content.replace('#current_agent_login#', agent_email);
                        node.content = node.content.replace('#current_agent_name#', agent_name);

                        // class for replacing session history in TRANSCRIPT
                        node.content = node.content.replace('##TRANSCRIPT##', '<div class="zt-all-clicks"></div>');

                        // make a class for replacing ALL DATA as well
                        node.content = node.content.replace('##ALL DATA##', '<div class="zt-all-data"></div>');

                        // class for replacing session notes
                        node.content = node.content.replace('#zt_session_notes#', '<pre><span class="zt-session-notes"></span></pre>');


                        // PDF Page breaks
                        node.content = node.content.replace('##PDF Page##', '<div style="page-break-after:always"></div>');

                        // make classes for AGENT-ONLY, USER-ONLY

                        node.content = node.content.replace(/\[\[AGENT-ONLY]]/g, '<div class="agent-only">');
                        node.content = node.content.replace(/\[\[USER-ONLY]]/g, '<div class="user-only">');
                        node.content = node.content.replace(/\[\[\/AGENT-ONLY]]/g, '</div>');
                        node.content = node.content.replace(/\[\[\/USER-ONLY]]/g, '</div>');

                        // classes for [COPY-AREA] and [/COPY-AREA]
                        node.content = node.content.replace(/\[\[COPY-AREA]]/g, '<div class="node-content-copy-area">');
                        node.content = node.content.replace(/\[\[\/COPY-AREA]]/g, '</div>');


                        // replace #agent# or #source# with the source= parameter in the URL

                        node.content = node.content.replace('#source#', source);
                        node.content = node.content.replace('#agent#', source);

                        // #session# is replaced by session ID
                        node.content = node.content.replace(/#session#/g, session_id);

                        // replace our hack for faux start and end tags
                        node.content = node.content.replace("<!--!", "<");
                        node.content = node.content.replace("!-->", ">");

                        node.content = node.content.replace(/##(.*?)##/g, function(match, m) {
                            var r = emitEvent("macroReplacement:" + m);
                            return r || match;
                        });
                        
                    }

                    // add class around just the content part (for bot mode)
                    node.content = '<div class="content-only">' + node.content + '</div>';


                    // lazy load? Replace src= tags with Lozad class and data-src
                    // also add to image classes in case we already havea class identifier there
                                        // turn Froala video span tags into bootstrap responsive tags
                    // up to 5 videos (should use Regex)

                    if (responsive_videos == 1) {
                        for (var i = 0; i < 5; ++i) {
                            node.content = node.content.replace(
                                '<span class="fr-video fr-fvc fr-dvb fr-draggable" contenteditable="false" draggable="true">',
                                '<div class="embed-responsive embed-responsive-16by9">'
                            );

                            node.content = node.content.replace(
                                '</iframe>&zwnj;&zwnj;</span>',
                                '</iframe></div>'
                            );
                        }
                    }


                    // render form fields, and make address mapping for address autocomplete/lookup

                    var addr = new Object();
                    var formnode = 'node_' + id + '_form';

                    // TODO: Grab this as a setting
                    var form_columns = node.form_columns;

                    // set style for required asterisk
                    formfields = "<style>.form-control.zt-data {display:initial !important;}</style>";

                    // start the form, adding autocomplete="off" if specified in Settings
                    if (disable_autocomplete == 0)
                        formfields += '<form id="' + formnode + '" onsubmit="return(false);">';
                    else
                        formfields += '<form autocomplete="off" id="' + formnode + '" onsubmit="return(false);">';

                    var hidden = '';

                    // cycle through entire form repeatedly if we have more than one repeat


                    var has_fields = false;

                    for (var j = 1; j <= node.repeat_form; ++j) {
                        if (node.repeat_form == 1)
                            index = 0; // no indexing for non-repeating forms
                        else
                            index = j;

                        formfields += '\n<div class="form_' + j + '" style="' + hidden + '">';


                        $.each(node.formfields, function (i, formfield) {

                            // make rows half-width for 2 column rendering

                            if (form_columns == 2) {
                                if (i % 2 == 0)
                                    formfields += '<div class="row"><div class="col-md-6">';
                                else
                                    formfields += '<div class="col-md-6">';
                            }

                            has_fields = true;

                            var label = formfield.label;
                            if (node.repeat_form != 1) {
                                // keep colon as last character if present
//                            if (label.endsWith(':'))  // not supported in IE 11 :(
                                if (label.match(":$")) {
                                    label = label.slice(0, -1);
                                    label += ' #' + j + ':';
                                } else
                                    label += ' #' + j;
                            }

                            var form_field_value;
                            if (typeof form_data[formfield['name']] !== 'undefined')
                                form_field_value = form_data[formfield['name']];
                            else
                                form_field_value = '';

                            // assign values to hidden fields
                            if (formfield.type == "hidden")
                                form_field_value = formfield.hidden_value;


                            formfields += render_formfield(id, formfield.type, formfield.name, form_field_value, label, formfield.options, formfield.required,
                                formfield.score_var, formfield.scores, formfield.custom_regex, formfield.inline, formfield.checkbox_score, formfield.label_type, index, form_columns);

                            // compile address mapping for address lookup if one of the special field types is in use

                            addr.id = 'node' + id;

                            if (formfield.type == 'address1')
                                addr.address1 = '#' + formfield.name;

                            if (formfield.type == 'address2')
                                addr.address2 = '#' + formfield.name;

                            if (formfield.type == 'city')
                                addr.locality = '#' + formfield.name;

                            if (formfield.type == 'state')
                                addr.administrative_area = '#' + formfield.name;

                            if (formfield.type == 'zip')
                                addr.postal_code = '#' + formfield.name;


                            // end of rows half-width for 2 column rendering

                            if (form_columns == 2) {
                                if (i % 2 == 0)
                                    formfields += '</div>';
                                else
                                    formfields += '</div></div>';
                            }


                        });

                        // add separator between repeating form entries (except last one)

                        if (node.repeat_form != 1)
                            formfields += '<hr>';


                        hidden = 'display:none';   // hides everything but first item


                        // create 'add another" button

                        var next = j + 1;
                        if ((node.repeat_form != j) && (has_fields))
                            formfields += '<div class="row"><div class="col-md-12"><a onmouseover="" style="cursor: pointer; margin-top: 10px;" class="btn btn-info btn-sm add_another_' + j + '" onclick="$(\'#' + formnode + ' .form_' + next + '\').show(); $(\'#' + formnode + ' .add_another_' + j + '\').hide();">+ Add Another</a></div></div>';

                        formfields += '</div>';


                    }


                    formfields += '</form>\n';


                    // if we have any file upload fields, add the submit form to the node, outside of the main form
                    // (nested forms not allowed in HTML)

                    var extra_line = "<br><br>";
                    $.each(node.formfields, function (i, formfield) {

                        if ((formfield.type == "file") || (formfield.type == "tempfile")) {
                                                        if (formfield.type == "tempfile")
                                fileform = "<form action=\"https://uploads.zingtree.com\" method=\"post\" class=\"form-horizontal\" role=\"form\" name=\"upload-[[FORM_ID]]-[[LOCATION]]\" id=\"upload-[[FORM_ID]]-[[LOCATION]]\" enctype=\"multipart/form-data\"><input type=\"hidden\" name=\"AWSAccessKeyId\" id=\"AWSAccessKeyId\" value=\"AKIAS32G7I2BK5EG23ZY\" /><input type=\"hidden\" name=\"key\" id=\"key\" value=\"tempdocs/433293119-${filename}\" /><input type=\"hidden\" name=\"acl\" id=\"acl\" value=\"public-read\" /><input type=\"hidden\" name=\"policy\" id=\"policy\" value=\"eyJleHBpcmF0aW9uIjoiMjAyMS0wNC0wMlQwODo1MDozNVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJ1cGxvYWRzLnppbmd0cmVlLmNvbSJ9LHsiYWNsIjoicHVibGljLXJlYWQifSx7InN1Y2Nlc3NfYWN0aW9uX3N0YXR1cyI6IjIwMSJ9LFsic3RhcnRzLXdpdGgiLCIka2V5IiwidGVtcGRvY3MvNDMzMjkzMTE5LSJdLFsic3RhcnRzLXdpdGgiLCIkQ29udGVudC1UeXBlIiwiIl0sWyJzdGFydHMtd2l0aCIsIiRDb250ZW50LURpc3Bvc2l0aW9uIiwiIl0sWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsMCw0MTk0MzA0MF1dfQ==\" /><input type=\"hidden\" name=\"signature\" id=\"signature\" value=\"xzm3aJ9Ycrpg5QxLc3lotKitXPQ=\" /><input type=\"hidden\" name=\"success_action_status\" id=\"success_action_status\" value=\"201\" /><input type=\"hidden\" name=\"Content-Type\" id=\"Content-Type\" value=\"application/octet-stream\" /><input type=\"hidden\" name=\"Content-Disposition\" id=\"Content-Disposition\" value=\"attachment; filename=\" /><label class=\"btn btn-sm btn-info  \" for=\"file-[[FORM_ID]]-[[LOCATION]]\"><input type=\"file\" name=\"file\" id=\"file-[[FORM_ID]]-[[LOCATION]]\" style=\"display:none;\" onchange=\"on_upload_submit('[[FORM_ID]]', '[[LOCATION]]', 2) ;\" ><span class=\"attachment-label\" id=\"filelabel-[[FORM_ID]]-[[LOCATION]]\">[[LABEL]]</span></label></form><br>";
                            else
                                fileform = "<form action=\"https://uploads.zingtree.com\" method=\"post\" class=\"form-horizontal\" role=\"form\" name=\"upload-[[FORM_ID]]-[[LOCATION]]\" id=\"upload-[[FORM_ID]]-[[LOCATION]]\" enctype=\"multipart/form-data\"><input type=\"hidden\" name=\"AWSAccessKeyId\" id=\"AWSAccessKeyId\" value=\"AKIAS32G7I2BK5EG23ZY\" /><input type=\"hidden\" name=\"key\" id=\"key\" value=\"docs/433293119-${filename}\" /><input type=\"hidden\" name=\"acl\" id=\"acl\" value=\"public-read\" /><input type=\"hidden\" name=\"policy\" id=\"policy\" value=\"eyJleHBpcmF0aW9uIjoiMjAyMS0wNC0wMlQwODo1MDozNVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJ1cGxvYWRzLnppbmd0cmVlLmNvbSJ9LHsiYWNsIjoicHVibGljLXJlYWQifSx7InN1Y2Nlc3NfYWN0aW9uX3N0YXR1cyI6IjIwMSJ9LFsic3RhcnRzLXdpdGgiLCIka2V5IiwiZG9jcy80MzMyOTMxMTktIl0sWyJzdGFydHMtd2l0aCIsIiRDb250ZW50LVR5cGUiLCIiXSxbInN0YXJ0cy13aXRoIiwiJENvbnRlbnQtRGlzcG9zaXRpb24iLCIiXSxbImNvbnRlbnQtbGVuZ3RoLXJhbmdlIiwwLDQxOTQzMDQwXV19\" /><input type=\"hidden\" name=\"signature\" id=\"signature\" value=\"mlRS2sGnLOe5BrSAuV/mrE7eqtI=\" /><input type=\"hidden\" name=\"success_action_status\" id=\"success_action_status\" value=\"201\" /><input type=\"hidden\" name=\"Content-Type\" id=\"Content-Type\" value=\"application/octet-stream\" /><input type=\"hidden\" name=\"Content-Disposition\" id=\"Content-Disposition\" value=\"attachment; filename=\" /><label class=\"btn btn-sm btn-info  \" for=\"file-[[FORM_ID]]-[[LOCATION]]\"><input type=\"file\" name=\"file\" id=\"file-[[FORM_ID]]-[[LOCATION]]\" style=\"display:none;\" onchange=\"on_upload_submit('[[FORM_ID]]', '[[LOCATION]]', 0) ;\" ><span class=\"attachment-label\" id=\"filelabel-[[FORM_ID]]-[[LOCATION]]\">[[LABEL]]</span></label></form><br>";

                            var request = $.ajax({
                                url: "/api/create-upload-form.php",
                                method: "POST",
                                data: {
                                    type: formfield.type,
                                    index: i,
                                    form_id: 'node_' + id + '_form',
                                    location: formfield.name,
                                    label: formfield.label
                                },
                                async: false,   // BD note: Would love to make this async:true, but then adding formdata to node content area - especially if ##data-entry-fields### is used - is unpredictable
                                dataType: "html"
                            });

                            // add upload button form generated by API call to the form

                            request.done(function (fileform) {

                                // add an extra line below "add another", but just once
                                if (node.repeat_form > 1)
                                    fileform = extra_line + fileform;
                                extra_line = "";

                                formfields += fileform;

                            });

                        }
                    });


                    // add to the address map array if the main address1 and zip fields are specified

                    if ((typeof (addr.address1) !== 'undefined') && (typeof (addr.postal_code) !== 'undefined'))
                        address_map.push(addr);

                    // insert or append form field data

                    if (-1 == node.content.indexOf("NOMACROS")) {
                        if (node.content.indexOf("##data-entry-fields##") == -1)    // not using ##data-entry-fields## macro
                            node.content += formfields;
                        else
                            node.content = node.content.replace("##data-entry-fields##", formfields);  // insert data entry into content area
                    }

                    // replace form variables in content areas with spans so we can merge them later
                    // so #name# gets replaced with <span class="ztvar-name">#name#</span>


                    // replace in the content areas

                    node.content = node.content.replace(/#(\w|-)+#/g, vreplace);
                    node.question = node.question.replace(/#(\w|-)+#/g, vreplace);
                    node.page_title = node.page_title.replace(/#(\w|-)+#/g, vreplace);


                    // load buttons or panels prototype

                    if (zt_style == "panels")
                        node_html = $("#panelnode0").html(); // use prototype from inside this document
                    else {
                        node_html = $("#buttonnode0").html(); // use prototype from inside this document


                        // determine span of buttons by buttons_across, or automatically if buttons_acros == 0

                        original_buttons_across = node.buttons_across;

                        if (node.buttons_across == 0)
                            node.buttons_across = node.buttons.length;

                        var span;

                        switch (Number(node.buttons_across)) {

                            case 1:
                                span = 12;
                                break;
                            case 2:
                                span = 6;
                                break;
                            case 3:
                                span = 4;
                                break;
                            case 4:
                                span = 3;
                                break;
                            default:
                                span = 2;
                                break;
                        }


                    }

                    id = node.project_node_id;

                    node_html = '<div style="display:none; " class="zingtree-node ' + node.tag_classes + '" id="' + idnode0 + node.project_node_id + '">' + node_html + '</div>';
                    $("#nodes").append(node_html);


                    if (view_all == 0)
                        $(idnode + id + " #node-title").html(node.page_title);

                    else
                        $(idnode + id + " #node-title").html(node.page_title + ': Node #' + id);


                    // hide title area if blank

                    if (node.page_title == '')
                        $(idnode + id + " .panels-node-title").hide();


                    var hideContent = (node.content == '');

                    // add class identifiers for question or answer nodes
                    // ID for content-answer is used for repurposing document nodes

                    if (node.buttons.length == 0)
                        node.content = '<div class="content-answer" id="content-answer-' + id + '">' + node.content + '</div>';
                    else
                        node.content = '<div class="content-question" id="content-answer-' + id + '">' + node.content + '</div>';


                    $(idnode + id + " #node-content").html(node.content);


                    // hide content area if blank

                    if (hideContent)
                        $(idnode + id + " .panels-node-content").hide();


                    // handle confirmation text
                    if (node.confirmation_text == '') {
                        $(idnode + id + " #node-confirmation").hide();
                    } else {
                        $(idnode + id + " #node-confirmation").html(
                            '<br><br>'+
                            '<label>' +
                            '<input type="checkbox" id="' + idnode0 + id + '-box" onclick="enable_buttons(\'' + idnode + id + '\');"> ' +
                            node.confirmation_text +
                            '</label>' +
                            '<br><br>');
                    }


                    

                    // hide the question area if empty or just '?', otherwise insert the question text

                    if ((node.question == '') || (node.question == '?')) {
                        if (node.buttons.length == 0)
                            $(idnode + id + " #qa-area").hide();  // no question or buttons? hide the entire area
                        else
                            $(idnode + id + " #question_area").hide();

                    } else
                        $(idnode + id + " #node-question").html(node.question);


                    // add buttons to the button area

                    $.each(node.buttons, function (i, button) {

                        if (
                            ((button.button_text.indexOf('USER_') == 0) && (view_as_agent != 0) && (agent_mode == 1)) ||
                            ((button.button_text.indexOf('USER_') == 0) && (hide_end_user_only == 1)) ||
                            ((button.button_text.indexOf('AGENT_') == 0) && (view_as_agent == 0)) ||
                            (button.button_text.substr(0,2) == '__')) {
                            // skip this button if it's Agent-Only, User-Only, or an action responder (e.g. __success)
                        } else {

                            // remove agent-only or user-only prefixes for display

                            button.button_text = button.button_text.replace('AGENT_', '');
                            button.button_text = button.button_text.replace('USER_', '');


                            // replace merge variables in buttons

                            $.each(zt_vars, function (i, zt_var) {
                                var re = new RegExp(escapeRegExp('#' + zt_var + '#'), "g");            // use a regexp to make sure ALL occurrences are replaced, not just first one
                                button.button_text = button.button_text.replace(re, '<span class="ztvar-'+zt_var+'">'+zt_vals[i]+'</span>');
                            });


                            // escape single and double quotes for do_button_click call
                            // we need to add extra slashes since the result is decoded twice

                            var button_click_text = button.click_text;
                            button_click_text = jQuery('<span>' + button_click_text + '</span>').text();   // strips HTML tags

                            var button_data = button.button_data;

                            // replace ALL instances of quotes.

                            button_click_text = button_click_text.replace(/"/g, "&quot;");
                            button_click_text = button_click_text.replace(/\'/g, "\\'");
                            button_click_text = button_click_text.replace(/&apos;/g, "\\'");

                            button_data = button_data.replace(/"/g, "&quot;");
                            button_data = button_data.replace(/\'/g, "\\'");
                            button_data = button_data.replace(/&apos;/g, "\\'");
                            button_data = button_data.replace(/&#39;/g, "\\'");


                            var onclick_action = 'do_button_click(' + button.button_link + ', ' + id + ', \'' + button_click_text + '\',' + button.value + ', \'' + button_data + '\');';

                            // set spans for dynamic variables to be replaced in button text
                            button.button_text = button.button_text.replace(/#(\w|-)+#/g, vreplace);

                            // make a node reference for print view

                                                        node_reference = '';
                            
                            // overriding the button class? If so, set the new class and delete the class text
                            // this is done by starting the button text with '.btn- '

                            var newclass = '';
                            var newpanelsclass = '';
                            if (button.button_text.search('.btn-') == 0) {
                                var sp = button.button_text.indexOf(' ');

                                newclass = button.button_text.substr(1, sp);
                                button.button_text = button.button_text.slice(sp + 1);

                                // multiple classes can be included, separated by dot - like .btn-yes.btn-green
                                // just replace other dots, and the class names work great!
                                newclass = newclass.replace(/\./g, ' ');
                                newpanelsclass = " " + newclass;
                                newclass = "btn-primary " + newclass;    // keep primary class just in case no colors are defined. This is overridden by other colors

                            }


                            // remove anything after '::' in button text display
                            // this is a button tag

                            var button_text_display = button.button_text.split('::')[0];

                            // set href and target for link nodes

                            var target = '';
                            var href = '#' + button.button_link;

                            // new direct links (1/2019)? Then make hrefs and targets for the button

                            if (
                                (typeof trees[tree_id].nodes[button.button_link] !== 'undefined')
                                && (trees[tree_id].nodes[button.button_link].type == 'Link')
                                && (trees[tree_id].nodes[button.button_link].link_direct == 1)) {

                                href = trees[tree_id].nodes[button.button_link].link;

                                // replace the session ID, source/agent in the link (if present)
                                href = href.replace('#session#', session_id);
                                href = href.replace('#agent#', source);
                                href = href.replace('#source#', source);

                                // open in new tab for link nodes
                                if (trees[tree_id].nodes[button.button_link].link_new_tab == 1)
                                    target = ' target="_blank" ';
                                else
                                    target = ' target="_top" ';    // embedded not-in-new-tab opens outside frame

                                onclick_action = '';				// must be empty, otyherwise pop-up blocker is triggered
                                var url = encodeURIComponent(href);

                                href = "/deploy/link-node-redirect.php?				click_text=" + encodeURIComponent(button_text_display) + "&source=" + encodeURIComponent(source) + "&agent_mode=" + agent_mode + "&master_tree_id=" + master_tree_id + "&tree_id=" + tree_id + "&from=" + id + "&to=" + button.button_link + "&result=" + encodeURIComponent(trees[tree_id].nodes[button.button_link].resolution_state) + "&session_id=" + session_id + "&url=" + url;


                            }


                            hover_code = '';


                            // panel action

                            if (zt_style == "panels") {

                                // include button hovers if specified
                                if (button.hover_text != '')
                                    hover_code = ' data-toggle="tooltip" data-placement="bottom" title="' + button.hover_text + '" ';


                                if (node.confirmation_text != '')
                                    btn_disabled = " ztdisabled";

                                else
                                    btn_disabled = "";


                                // special red attribute for unlinked buttons
                                if (button.button_link == 0)
                                    panel_type = "list-group-item-danger";
                                else
                                    panel_type = "";


//                            a = '<a class="btn-zingtree list-group-item '+panel_type + btn_disabled + '" href="#'+button.button_link+'" onclick="'+onclick_action+'"><strong><i class="fa fa-chevron-right"></i></strong>&nbsp;'+button_text_display+node_reference+'</a>' ;
                                a = '<a class="btn-zingtree list-group-item ' + panel_type + btn_disabled + newpanelsclass + '" ' + target + 'href="' + href + '" onclick="' + onclick_action + '"' + hover_code + '><strong><i class="fa fa-chevron-right"></i></strong>&nbsp;' + button_text_display + node_reference + '</a>';
                            }

                            // button action

                            else {

                                if (button.hover_text != '')
                                    hover_code = ' data-toggle="tooltip" data-placement="bottom" title="' + button.hover_text + '" ';


                                if (node.confirmation_text != '')
                                    btn_disabled = " disabled";
                                else
                                    btn_disabled = "";

                                // modify for unlinked buttons
                                if (button.button_link == 0)
                                    btn_type = "btn-danger";

                                // linked button uses btn-primary, unless we overrode the class in the button text

                                else {
                                    if (newclass == '')
                                        btn_type = "btn-primary";

                                    else
                                        btn_type = newclass;
                                }

                                // make button class spans
                                // for one across (span == 12), make a shorter, centered single button

                                if (span == 12) {
                                    if (original_buttons_across == 1)   // one across is truly one across
                                        span_class = 'col-md-12 col-sm-12';
                                    else
                                        span_class = 'col-md-offset-3 col-md-6 col-sm-12'; // otherwise "automatic" with one button shows a shorter button

                                } else
                                    span_class = 'col-sm-' + span;


                                // don't add extra space on last item

                                if (node.buttons.length == i + 1)
                                    br = '';
                                else
                                    br = '<br>';

                                a = '<div class="' + span_class + '">' +
                                    '<a class="btn btn-lg btn-zingtree btn-block ' + btn_type + btn_disabled + ' " href="' + href + '" ' + target + ' onclick="' + onclick_action + '" ' + hover_code + ' >' + button_text_display + node_reference + '</a>' + br +
                                    '</div>';
                            }

                            // add the action to the answers area

                            $(idnode + id + " .answers").append(a);

                        }

                    });


                }


                // ***** EMAIL nodes


                else if (node.type == "Email") {

                    id = node.project_node_id;

                    // auto-email: just show a summary for thumbnails overview

                    if (node.email_send_now == 1) {
                        node_html = $("#email-auto").html();

                        node_html = '<div style="display:none; " class="zingtree-node ' + node.tag_classes + '" id="' + idnode0 + id + '">' + node_html + '</div>';
                        $("#nodes").append(node_html);
                        $('#' + idnode0 + id + " #node-number").text(id + " (Auto Send)"); // insert node number in view all mode
                    }


                    // email forms: use prototype from inside this document for buttons or panels style

                    else {

                        if (zt_style == "panels")
                            node_html = $("#panelemail0").html();
                        else
                            node_html = $("#buttonemail0").html();

                        node_html = '<div style="display:none; " class="zingtree-node ' + node.tag_classes + '" id="' + idnode0 + node.project_node_id + '">' + node_html + '</div>';
                        $("#nodes").append(node_html);


                        // replace merge variables

                        $.each(zt_vars, function (i, zt_var) {

                            zt_var = '#' + zt_var + '#';
                            //                    zt_var = escapeRegExp ('#'+zt_var+'#') ;
                            //                    var re = new RegExp(zt_var,"g");            // use a regexp to make sure ALL occurrences are replaced, not just first one

                            node.email_body = node.email_body.replace(zt_var, zt_vals[i]);
                            node.email_subject = node.email_subject.replace(zt_var, zt_vals[i]);
                            node.email_preheader = node.email_preheader.replace(zt_var, zt_vals[i]);
                            node.page_title = node.page_title.replace(zt_var, zt_vals[i]);

                            // replace "from" field with merge variable #email# if it exists
                            // also name field with #name#

                            if (zt_var == '#email#')
                                $(idnode + id + " #email").val(zt_vals[i]);

                            if (zt_var == '#name#')
                                $(idnode + id + " #name").val(zt_vals[i]);


                        });


                        // page title: includes node # if in view_all from button clicks report

                        $(idnode + id + " .panel-title").html(node.page_title);

                        // content fields

                        $(idnode + id + " #subject").val(node.email_subject);
                        $(idnode + id + " #preheader").val(node.email_preheader);
                        $(idnode + id + " #message").html(node.email_body);

                        // set continuation button text if specified
                        if (node.continuation_button_text != '')
                            $(idnode + id + " #email-form-send-message-text").html(node.continuation_button_text);

                                                $(idnode + id + " #node-title").html(node.page_title);

                        
                        
                        // hidden form fields

                        $(idnode + id + " #session_id").val(session_id);
                        $(idnode + id + " #project_id").val(tree_id);
                        $(idnode + id + " #project_node_id").val(id);

                    }

                                    }

                // other node types (not Content or Email) -- display for Overview

                else {
                    
                }

                // show all nodes (for Preview or Button Clicks report)
                


                
                // make Froala Block style images and videos responsive

                $(".fr-dib").addClass("img-responsive");

                

                // make initial node appear immediately
                /*
              if (trees[this_tree_id].root_node_id == node.project_node_id)
				  refresh_display() ;
*/
            });


// initialize the date picker for subtrees

            if ((action == "init") || (action == "launch")) {

                // init the datepicker
                // this must occur after the tree has loaded

                $('[type=date]').datepicker({
                    changeMonth: true,
                    changeYear: true,
                    constrainInput: true,
                    yearRange: "c-90:c+10"
                });

                $('.datepicker').datepicker({
                    changeMonth: true,
                    changeYear: true,
                    constrainInput: true,
                    yearRange: "c-90:c+10"
                });

                //           $.datepicker.setDefaults($.datepicker.regional[GetDatePickerRegion('en-IN')]);

                var datePickerRegion = GetDatePickerRegion('en-IN');
                $.datepicker.setDefaults(datePickerRegion);

                
            }

            // Now, the html is rendered, but the vars have not yet been replaced
            emitEvent('render:finish', {
                treeId: tree_id,
                treeDefinition: tree
            })


            // initialize the history stacks once the tree has loaded

            if (action == "init") {


                // run the init app (if set)

                var init_app_ids = [];
                var init_app_messages = [];
                var init_apps = [];
                var init_node_numbers = [];

                var init_app_count = 0;


                // see if tree has an init app, and add it to the list to execute

                if (tree.app_id != 0) {
                    init_apps.push(tree.app);
                    init_app_ids.push(tree.app_id);
                    init_app_messages.push(tree.app_message);
                    init_node_numbers.push(0);
                    ++init_app_count;
                }

                // see if root node has apps, and if so add them to a list to execute

                if ((typeof tree.nodes[this_node_id] !== "undefined") && (typeof tree.nodes[this_node_id].app_messages[0] !== "undefined") && (tree.root_node_id == this_node_id)) {
                    for (var i = 0; i < 10; ++i) {
                        if (typeof trees[this_tree_id].nodes[this_node_id].app_messages[i] === 'undefined')
                            break;

                        init_apps.push(tree.nodes[this_node_id].app_messages[i].app);
                        init_app_ids.push(tree.nodes[this_node_id].app_messages[i].app_id);
                        init_app_messages.push(tree.nodes[this_node_id].app_messages[i].message);
                        init_node_numbers.push(this_node_id);

                        ++init_app_count;
                    }
                }


                // run the initial apps if we have any
                // fix for ZA-292 - changed the call from async:true to async:false

                form_data_string = make_form_data_string(form_data);

                form_changes = {};
                for (var i = 0; i < init_app_count; ++i) {

                    if (init_apps[i] != '') {
                        var request2 = $.ajax({
                            url: app_message_url,
                            method: "POST",
                            data: {
                                master_tree_id: master_tree_id,
                                tree_id: this_tree_id,
                                session_id: session_id,
                                app: init_apps[i],
                                app_id: init_app_ids[i],
                                message: init_app_messages[i],
                                form_data: form_data_string,
                                source: source,
                                node_number: init_node_numbers[i],
                                from_node_number: 0,
                                auth_token: auth_token, sf_id: ''
                            },
                            async: false,   // ** was TRUE, changes so that initial webhook calls would finiosh before logic nodes triggered
                            dataType: "html",
                            uid: uid
                        });

                        request2.done(function (msg) {
                            log(msg);

                            if (msg[0] == '*')
                                alert(msg);
                            else {

                                // add JSON result to form_data
                                // refresh the display after we receive data (if we receive any data)

                                try {
                                    var json = JSON.parse(msg);

                                    var do_refresh = 0;
                                    for (var key in json) {
                                        // ensure webhook results are not arrays
                                        if (Array.isArray(json[key]) === false) {
                                            // turn NULL values into empty strings

                                            if (json[key] == null)
                                                json[key] = '';

                                            // add new variable to form data
                                            form_changes[key] = form_data[key] = json[key];
                                            do_refresh = 1;
                                        }
                                    }
                                } catch (e) {
                                }

                                if (do_refresh == 1)
                                    refresh_display();

                            }

                        });

                    }
                }
                emitEvent('webhooksComplete', form_changes);


                // init scores and values for checkboxes
                // unchecked elements get a value of 0
                // score_vars also get defaulted to zero

                $("input:checkbox").each(function (index) {
                    if ($(this).hasClass('zt-data')) {
                        /*
                    var v = 0 ;
                    if ($(this)[0].checked)
                        v = $(this).val() ;

                    form_data[$(this).attr('name')] = v;
*/
                        // score in checkbox variables
                        if (typeof $(this).attr('score') !== "undefined") {
                            score_var = get_score_var(this);
                            if (typeof form_data[score_var] === 'undefined')
                                form_data[score_var] = 0;
                        }
                    }

                });


                // init radio button scores (unless already initialized)

                $('input[type="radio"]').each(function (index) {

                    if ($(this).hasClass('zt-data')) {

                        // score in checkbox variables
                        if (typeof $(this).attr('score') !== "undefined") {
                            score_var = get_score_var(this);
                            if (typeof form_data[score_var] === 'undefined')
                                form_data[score_var] = 0;
                        }
                    }


                });


                // make the form data as a string to send to tracker

                form_data_string = make_form_data_string(form_data);
                emitEvent('sessionReported');

                
                // set escalation countdown timer if we escalate on root node
                var init_escalate_after = 0;
                if (tree_id == this_tree_id) {
                    if ((this_node_id <= 999) && (typeof trees[this_tree_id].nodes[this_node_id] !== 'undefined')) {
                        init_escalate_after = trees[this_tree_id].nodes[this_node_id].escalate_after;
                        set_escalation(60 * init_escalate_after);
                    }
                }

                // start logging the session data

                ++click_num;   // keep click events in sync

                var request = $.ajax({
                    url: tracking_url,
                    method: "POST",
                                        data: {
                        source: source,
                        agent_mode: agent_mode,
                        init: 1,
                        to: this_node_id,
                        tree_id: this_tree_id,
                        master_tree_id: master_tree_id,
                        session_id: session_id,
                        form_data: form_data_string,
                        instance: "8A",
                        click_num: click_num,
                        escalate_after: init_escalate_after,
                        uri: uri
                    },
                                        async: true,
                    dataType: "html",
                    uid: uid

                });

                request.done(function (msg) {
                    log("Init: " + msg);

                });


                

                // hide agent-only or user-only content
                // view_as_agent is only set from Preview (view.php). We check this first.

                if (view_as_agent == 1)
                    $(".user-only").hide();
                else if (view_as_agent == 0)
                    $(".agent-only").hide();
                else {
                    if (agent_mode == 1)
                        $(".user-only").hide();

                }

                // special flag to hide end-user-only content

                if (hide_end_user_only==1)
                    $(".user-only").hide();


                // show the history/breadcrumbs
                refresh_display();



                
            }

// redraw: make the display up-to-date

            else if (action == "redraw") {

                // load the form data using our JSON API

                $.getJSON("/api/get-form-data.php?session_id=" + session_id, function (data) {

                    form_data = data;

                    // add merge variables again (in case we have any new ones)
                    // old ones will get overwritten by state reload

                    $.each(zt_vals, function (i, zt_val) {

                        // convert strings to numbers if they are numeric
                        if ($.isNumeric(zt_vals[i]))
                            zt_vals[i] = Number(zt_vals[i]);
                        else
                            zt_vals[i] = decodeURIComponentSafe(zt_vals[i].replace(/\+/g, " "));


                    });


                    $.each(zt_vars, function (i, zt_var) {
                        zt_vars[i] = decodeURIComponentSafe(zt_vars[i].replace(/\+/g, " "));
                        if ((typeof zt_vals[i] !== "undefined") && (typeof form_data[zt_vars[i]] === 'undefined'))  // just replace anything not already reloaded
                            form_data[zt_vars[i]] = zt_vals[i];
                    });


                    // stuff form data back into (not hidden) form fields

                    $(".zt-data").each(function (index) {
                        // reload text and textarea data
                        if (($(this).attr('type') != 'radio') && ($(this).attr('type') != 'checkbox') && ($(this).attr('type') != 'hidden'))
                            $(this).val(data[$(this).attr('name')]);

                        // set checkboxes
                        else if (($(this).attr('type') == 'checkbox') && (typeof data[$(this).attr('name')] != "undefined") && (data[$(this).attr('name')] != "0") && (data[$(this).attr('name')] != false))
                            $(this).prop('checked', true);

                        // set radio buttons
                        else if ($(this).attr('type') == 'radio') {
                            if (this.value == data[$(this).attr('name')])
                                this.checked = true;

                        }

                    });


                    refresh_display();

                });

                refresh_display();
            }


// Launch: open tree from a subtree node

            else if (action == "launch") {

                // set the new node and tree IDs
                // we needed to wait until after the tree was loaded to get the root node ID

                // start from the root, or the passed-in start node if not zero
                if (new_start_node == 0)
                    this_node_id = trees[tree_id].root_node_id;
                else
                    this_node_id = new_start_node;


                this_tree_id = tree_id;

                // tell preview edit node buttons we have a new node and tree ID

                parent.postMessage("Tree=" + this_tree_id, "*");
                parent.postMessage("Node=" + this_node_id, "*");
                parent.postMessage("Treename=" + trees[this_tree_id].name, "*");
                emitEvent("nodeTransition", {
                    treeId: this_tree_id,
                    toNodeId: this_node_id
                });

                
                // save new node in history
                // other stack items are already done in do_button_click()

                button_history.push(this_node_id);
                tree_history.push(this_tree_id);


                // update form data string in case a webhook is called

                form_data_string = make_form_data_string(form_data);

                // make sure node exists in tree

                if (typeof trees[this_tree_id].nodes[this_node_id] === 'undefined') {
                    alert("Warning: Node #" + this_node_id + " does not exist in tree #" + this_tree_id + ". Unable to continue.");
                }



                // send app messages contained in start node of loaded tree

                else {

                    form_changes = {};
                    for (var i = 0; i < 10; ++i) {
                        if (typeof trees[this_tree_id].nodes[this_node_id].app_messages[i] === 'undefined')
                            break;

                        //       alert (trees[this_tree_id].nodes[show].app_messages[i].app + ': ' + trees[this_tree_id].nodes[show].app_messages[i].message) ;

                        var request2 = $.ajax({
                            url: app_message_url,
                            method: "POST",
                            data: {
                                master_tree_id: master_tree_id,
                                tree_id: this_tree_id,
                                session_id: session_id,
                                app: trees[this_tree_id].nodes[this_node_id].app_messages[i].app,
                                app_id: trees[this_tree_id].nodes[this_node_id].app_messages[i].app_id,
                                message: trees[this_tree_id].nodes[this_node_id].app_messages[i].message,
                                form_data: form_data_string,
                                source: source,
                                node_number: this_node_id,
                                from_node_number: 0,
                                auth_token: auth_token,
                                sf_id: ''
                            },
                            async: true,
                            dataType: "html",
                            uid: uid

                        });

                        request2.done(function (msg) {
                            log(msg);

                            if (msg[0] == '*')
                                alert(msg);
                            else {

                                // add JSON result to form_data
                                // refresh the display after we receive data (if we receive any data)

                                try {
                                    var json = JSON.parse(msg);

                                    var do_refresh = 0;
                                    for (var key in json) {
                                        // ensure webhook results are not arrays
                                        if (Array.isArray(json[key]) === false) {
                                            // turn NULL values into empty strings

                                            if (json[key] == null)
                                                json[key] = '';

                                            // add new variable to form data
                                            form_changes[key] = form_data[key] = json[key];
                                            do_refresh = 1;
                                        }
                                    }

                                    if (do_refresh == 1)
                                        refresh_display();
                                } catch (e) {
                                }

                            }

                        });


                    }
                    emitEvent('webhooksComplete', form_changes);

                }


                // show the latest node and history

                refresh_display();


                // if this page is embedded in an iFrame, scroll the hosting page to show the top of the iFrame

                fix_scroll();


                // get the resolution state for the starting node
                var resolution_state = trees[this_tree_id].nodes[this_node_id].resolution_state;
                signalResolution(resolution_state);

                // hide agent-only or user-only content
                // view_as_agent is only set from Preview (view.php). We check this first.

                if (view_as_agent == 1)
                    $(".user-only").hide();
                else if (view_as_agent == 0)
                    $(".agent-only").hide();
                else {
                    if (agent_mode == 1)
                        $(".user-only").hide();
                }


                // async log the button click event (except for Gallery?)

                
                form_data_string = make_form_data_string(form_data);
                emitEvent('sessionReported');

                ++click_num;   // keep click events in sync

                // use name of tree as button text if we don't have anything here

                if (last_node_id >= 1000)
                    last_button_text = trees[this_tree_id].name;

                set_escalation(60 * trees[this_tree_id].nodes[this_node_id].escalate_after);

                var request = $.ajax({
                    url: tracking_url,
                    method: "POST",
                    data: {
                        source: source,
                        agent_mode: agent_mode,
                        tree_id: trees[this_tree_id].tree_id,
                        master_tree_id: master_tree_id,
                        session_id: session_id,

                        from: last_node_id,
                        to: this_node_id,
                        click_text: last_button_text,
                        resolution_state: resolution_state,
                        form_data: form_data_string,
                        instance: "9",
                        click_num: click_num,
                        tag: trees[this_tree_id].nodes[this_node_id].tag,
                        escalate_after: trees[this_tree_id].nodes[this_node_id].escalate_after
                    },
                    async: true,
                    dataType: "html",
                    uid: uid
                });

                request.done(function (msg) {
                    log(msg);

                });
                
            }


            // handle scoring or A/B nodes as root node
            // handles first load, or tree node launch

            if ((action == "init") || (action == "launch")) {

                // make sure we have a tree and a node
                if ((typeof trees[this_tree_id].nodes !== "undefined") && (typeof trees[this_tree_id].nodes[this_node_id] !== "undefined")) {

                    // handle scoring/logic node as root node

                    if (trees[this_tree_id].nodes[this_node_id].type == "Scoring") {
                        do_logic_jump(this_node_id);
                        return;
                    }

                    // handle tree node as root node

                    if (trees[this_tree_id].nodes[this_node_id].type == "Tree") {

                        if (trees[this_tree_id].nodes[this_node_id].open_tree_id > 1) {
                            push_tree_launch_history(this_tree_id, trees[this_tree_id].nodes[this_node_id].return_tree_node_id);

                            last_tree_id = this_tree_id;
                            open_tree_node_id = trees[this_tree_id].nodes[this_node_id].open_tree_node_id;    // start node for new tree (read this before changing this_tree_id below)
                            this_tree_id = trees[this_tree_id].nodes[this_node_id].open_tree_id;    // sets current tree


                            // load the tree, and do the launch action (unless we're in a thumbnail overview or report)

                            if ((show_all != 1) && (view_all != 1))
                                load_tree(this_tree_id, "launch", open_tree_node_id);
                        }

                        // no tree specified? try a 'return", or show an alert if there's nothing on the return stack
                        else {
                            // if we have something in the launch stack, get it and use the tree and node. This is the "return" capability.
                            if ((trees[this_tree_id].nodes[this_node_id].open_tree_id == 1) && (tree_launch_history.length > 0)) {
                                this_tree_id = tree_launch_history.pop();

                                open_tree_node_id = tree_launch_return_node_history.pop();
                                load_tree(this_tree_id, "launch", open_tree_node_id);

                            } else {
                                if (trees[this_tree_id].nodes[this_node_id].open_tree_id == 1)
                                    alert('Zingtree message: A Tree return request was received, but ther eis no previous tree to return to.');
                                else
                                    alert('Zingtree message: An attempt to load a new tree occurred, but no valid tree was specified. Check root node in tree #' + last_tree_id + '.');
                            }
                        }

                        return;

                    }

                }

            }

            // *** tree has finished loading

            // load content from URL includes asynchronously
            // get each div of class zt-include, and retrieve the URL from the src= attribute
            // i.e. <div class="zt-include" src="http://google.com"></div>

            $('.zt-include').each(function (i, obj) {

                // ensure include URL has http in it.
                // it can be from src= attribute, or data-src= attribute (if lazyload is in effect)

                var include_url = '';
                if ((typeof $(obj).attr("src")) !== 'undefined') {
                    include_url = $(obj).attr("src");
                } else if ((typeof $(obj).attr("data-src")) !== 'undefined') {
                    include_url = $(obj).attr("data-src");
                }


                if (include_url.indexOf('http') == 0) {

                    var request2 = $.ajax({
                        url: include_url,
                        method: "GET",
                        async: true,
                        timeout: 8000,     // allow 8 seconds max to load
                        dataType: "html"
                    });

                    // fill data field with results of URL load
                    request2.done(function (data) {
                        $(obj).html(data);
                        $(".fr-dib").addClass("img-responsive");	// makes images responsive

                    });

                    // fill data field with error message
                    request2.error(function (data1, data2, data3) {
                        $(obj).html("Error loading URL - see browser Developer Tools Console for details");

                    });
                }

            });

            // init tooltips
            $('[data-toggle="tooltip"]').tooltip();

            log("End of tree load");

            // see if we need to reload webhooks on the current node
            if (run_webhook == 1) {
                run_webhook = 0;
//			tree_id, action, new_start_node
                if (action == "init") {
                    do_webhooks(tree_id, new_start_node, 0);

                }
            }


            
            emitEvent('render:replacementsComplete', {
                treeId: tree_id,
                treeDefinition: tree
            })
            
        });


    }

    // refresh the display


    function refresh_display() {

        // no need to refresh anything if we're in thumbnail preview mode

        if ((show_all == 1) || (view_all == 1))
            return;


        // update the history
        update_history_display();

// hide persistent buttons if specified

        if (
            (this_node_id < 1000) &&
            (typeof trees[this_tree_id] !== "undefined") &&
            (typeof trees[this_tree_id].nodes !== "undefined") &&
            (typeof trees[this_tree_id].nodes[this_node_id] !== "undefined") &&
            (trees[this_tree_id].nodes[this_node_id].hide_persistent_buttons == 1)
        )
            $(".persistent-button").hide();
        else
            $(".persistent-button").show();


// hide the back and restart buttons if specified in the node

        if (
            (this_node_id < 1000) &&
            (typeof trees[this_tree_id] !== "undefined") &&
            (typeof trees[this_tree_id].nodes !== "undefined") &&
            (typeof trees[this_tree_id].nodes[this_node_id] !== "undefined") &&
            (trees[this_tree_id].nodes[this_node_id].hide_back_restart == 1)) {
            $("#back_button").hide();
            $("#restart_button").hide();
        }
        // hide the back and restart buttons if there's nothing to go back to

        else if (button_text_history.length <= 1) {
                        $("#back_button").hide();
            $("#restart_button").hide();
            
        } else {
            $("#back_button").show();
            $("#restart_button").show();
        }


        hide_elt = ".zingtree-node";

        $("#node1002").hide(); // hide search results
        $("#node1004").hide(); // hide tree search results

        // hide the end of the process step message if this is a task
        if (is_process)
            $("#process-step-end").hide();


        // show just the current node in the active tree
        // there is just one search results node (1002), so we handle this special

        if (this_node_id == 1002)
            show_elt = "#node1002";    // $("#node1002").show() ;
        else if (this_node_id == 1004)
            show_elt = "#node1004";    // $("#node1004").show() ;
        else {
            var idnode = '#node-' + this_tree_id + '-';
            //       $(idnode+this_node_id).show() ;
            show_elt = idnode + this_node_id;
        }

// handle process trees

        if ((is_process) && (typeof trees[this_tree_id].nodes !== 'undefined')) {
            // process task reaches a complete state? Finish and close the task
            if (trees[this_tree_id].nodes[this_node_id].resolution_state != '?') {

                // complete and close the task

                var request = $.ajax({
                    url: task_complete_url,
                    method: "POST",
                    data: {session_id: session_id, status: trees[this_tree_id].nodes[this_node_id].resolution_state},
                    async: true,
                    dataType: "html",
                    uid: uid
                });

                request.done(function (msg) {
                    log(msg);
                });

                // show prompt to return to tasks

                $("#task-completed").show();

            }

            // if the agent is not authorized for the next step, show a message instead
            else if (!do_tags_match(trees[this_tree_id].nodes[this_node_id].tag, agent_tags)) {
                $("#process-group-next").text(trees[this_tree_id].nodes[this_node_id].tag);

                // hide the next content node, showing a check-in message instead
                if (trees[this_tree_id].nodes[this_node_id].type == 'Content')
                    show_elt = "#process-step-end";


                // check in the task, and assign it to the next group(s)

                var request = $.ajax({
                    url: task_checkin_url,
                    method: "POST",
                    data: {session_id: session_id, last_agent: source, next_groups: trees[this_tree_id].nodes[this_node_id].tag},
                    async: true,
                    dataType: "html",
                    uid: uid
                });

                request.done(function (msg) {
                    log(msg);
                });


            }

        }


        

        // do the transition, unless we're waiting for end of click processing
        // email auto-sends don't do transitions right now

        //   if ( (trees[this_tree_id].nodes[this_node_id].type != 'Email') ||  (trees[this_tree_id].nodes[this_node_id].continuation_node_id == 0) )
        //       show_elt = "#nobody" ;

        do_transition(hide_elt, show_elt);

        // calculate the running session score, and insert into the content
        // this is backward compatible with previous single variable scoring method

        if (typeof form_data !== "undefined") {


            if (typeof form_data['score'] !== "undefined")
                $(idnode + this_node_id + " #zt_score").text(form_data['score']);

            // init select boxes based upon score variable and value (for Richard DJ)
            // this may override if a variable is set

            $.each(form_data, function (key, value) {
                // only auto-populate if there is a nonzero value for the scoring variable
                if ((value != 0) && ($.isNumeric(value))) {
                    // make sure this is just a scoring variable init. If we have form data for the name of the listbox, then don't set it

                    var name = $('select[score_var="' + key + '"]').first().attr('name');
                    if (typeof form_data[name] === 'undefined') {
                        $('select[score_var="' + key + '"]').find('option[score="' + value + '"]').attr("selected", true);
                        $('input[score_var="' + key + '"][score="' + value + '"]').prop("checked", true);	// default radio buttons and checkboxes
                    }

                }


            });

            // update form variables in the tree
            // form variables have been changed into classes like "ztvar-name" for a variable called "name"
            // also collects all variables to replace any ##ALL DATA## areas

            var all_data = '\n<table class="table"><tr><th>Field: </th><th>Value</th></tr>\n\n';

            $.each(form_data, function (key, value) {
                // if variable has a _lc suffix, make the value lowercase, and convert master form data
                if (("_lc" == key.substring(key.length - 3, key.length)) && (typeof value == "string")) {
                    value = value.toLowerCase();
                    form_data[key] = value;
                }

                // changed from text() to html() to allow for webhooks to insert html data (i.e. dynamic forms)
                $('.ztvar-' + key).html(value);

                // populate email form with #name# and #email# form values
                if (key == "zt-email")
                    $('.ztemail-email').val(value);

                else if (key == "zt-name")
                    $('.ztemail-name').val(value);

                    // update text form entry fields and textareas
                // blank values don't overwrite previous entries (h/t Chris P.)

                else if ((key != '') && (value != '')) {
                    $("textarea[name='" + key + "']").val(value);

                    // update text input boxes (single . erases text input boxes)
                    if (value == '.')
                        $("input[name='" + key + "'][type='text']").val('');
                    else
                        $("input[name='" + key + "'][type='text']").val(value);

                    // file and hidden types don't like this, but other types can be set this way
                    if (((typeof ($("input[name='" + key + "'][type='file']").val())) === 'undefined') &&
                        ((typeof ($("input[name='" + key + "'][type='hidden']").val())) === 'undefined') &&
                        ((typeof ($("input[name='" + key + "'][type='radio']").val())) === 'undefined')) {
                        $("input[name='" + key + "']").val(value);
//					console.log (key + "= " + value + "\n") ;
                    }

                    // update an img src tag if value is a URL, and we have an image with an id that matches the variable
                    if ((typeof value === 'string') && (value.indexOf("http") == 0)) {
                        if ((value.indexOf("gif") != -1) || (value.indexOf("jpg") != -1) || (value.indexOf("png") != -1))
                            $("img[id='" + key + "']").attr("src", value);


                        // update href links if ID or class matches variable name and value is an http string (dynamic links)

                        $("#" + key).attr("href", value);
                        $("." + key).attr("href", value);

                    }


                    // choose previous option in dynamic list boxes (for Raj)
                    $('select[name="' + key + '"]').find("option").attr("selected", false);	// unselect any previous item (Ruisa)
                    $('select[name="' + key + '"]').find('option[value="' + value + '"]').attr("selected", true);
                    $('select[name="' + key + '"]').val(value).change();	// needed to actually make the display change (Paul N.)


                }

//			if ((key != '') && (value == ''))
//				$('select[name="'+key+'"]').find("option").attr("selected", false);	// unselect any previous item (Yassine)

                if (key != '')
                    all_data += "<tr><td>" + key + ": </td><td>" + value + "</td></tr>\n";


            });

            all_data += "</table>";

            // replace the ALL_DATA area(s)
            $(".zt-all-data").html(all_data);

        }


// set the title of the current tree (in case of subtrees)

        if (typeof trees[this_tree_id] !== "undefined") {
            $('#title').html(trees[this_tree_id].name);
            $('.zt_title').html(trees[this_tree_id].name);    // for hosting frame
        }

// update any tree IDs and node numbers in containers (agent portal, for example)

        $('#zt-node-number').text(this_node_id);
        $('#zt-tree-id').text(this_tree_id);

                get_notes('node');
        
    }

    

    

    // keep track of how many ttrees need loading
    // this is used to trigger escalation on last tree load
    var load_tree_count = 1;


    // reload the history stacks if a session ID was passed in

    function load_trees() {

        
        load_tree(842095957, "redraw", 0);

        
    }

    // reload the history stacks if a session ID was passed in

    function load_state(tree_id) {
        click_num = 0;



                load_tree(tree_id, "init", 0);

        // save home page in the history if we're starting fresh
        tree_history.push(tree_id);
        button_history.push(this_node_id);
        button_text_history.push('Start');

        return;
        
        // remove last item to keep state like it was before

        if (keep_vars_on_back != 1)
            form_data_history.pop();


// once the state stack is loaded, load all the trees next
// each tree load will redraw the display

        if (start_node <= 999)
            this_node_id = start_node;

        this_tree_id = 842095957 ;   // 0803

        // ensure last node in history is accurate

        button_history.pop() ;
        button_history.push(this_node_id);

        tree_history.pop() ;
        tree_history.push(this_tree_id);
        load_trees();


    }


    // runs webhooks for a specific node

    function do_webhooks(tree_id, node_id, from_node_id) {
        form_data_string = make_form_data_string(form_data);

        form_changes = {};
        for (i = 0; i < 10; ++i) {
            if (typeof trees[tree_id].nodes[node_id].app_messages[i] === 'undefined')
                break;


            var request2 = $.ajax({
                url: app_message_url,
                method: "POST",
                data: {
                    master_tree_id: master_tree_id,
                    tree_id: tree_id,
                    session_id: session_id,
                    app: trees[tree_id].nodes[node_id].app_messages[i].app,
                    app_id: trees[tree_id].nodes[node_id].app_messages[i].app_id,
                    message: trees[tree_id].nodes[node_id].app_messages[i].message,
                    form_data: form_data_string,
                    source: source,
                    node_number: node_id,
                    from_node_number: from_node_id,
                    auth_token: auth_token,
                    sf_id: ''
                },
                async: false,  // ** was TRUE -- makes it so that webhooks and apps finish before we continue.
                timeout: 15000,     // give the scripts 15 seconds
                dataType: "html",
                uid: uid
            });

            request2.done(function (msg) {
                log(msg);
                $("#link-wait").hide();

                if (msg[0] == '*')
                    alert(msg);
                else {

                    // add JSON result to form_data
                    // refresh the display after we receive data (if we receive any data)

                    var do_refresh = 0;
                    if (msg != '') {
                        try {
                            var json = JSON.parse(msg);

                            for (var key in json) {
                                // ensure webhook results are not arrays
                                if (Array.isArray(json[key]) === false) {
                                    // turn NULL values into empty strings

                                    if (json[key] == null)
                                        json[key] = '';

                                    // add new variable to form data
                                    form_changes[key] = form_data[key] = json[key];
                                    do_refresh = 1;
                                }
                            }
                        } catch (e) {
                        }
                    }

                    if (do_refresh == 1)
                        refresh_display();

                }

            });


        }
        emitEvent('webhooksComplete', form_changes);

    }


    // copyright this code in such a way that it shows up even in minified version
    var copyright = "(C) Copyright 2021 Zingtree Inc. All Rights Reserved";

    // make sure display is accurate after entire page has finished loading
    $(document).ready(function () {

                this_node_id = button_history[button_history.length - 1];

                this_tree_id = tree_history[tree_history.length - 1];
        refresh_display();

    });

    var restart_tree_id = 842095957;
    var restart_node_id = 1;

    // blocking delay
    // use sparingly, and not for more than 10 seconds

    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds) {
                break;
            }
        }
    }

    // can use this for copy to clipboard buttons within nodes

    /*
function copyToClipboard(element) {
  var $temp = $("<textarea>");
  $("body").append($temp);
  $temp.val($(element).text()).select();
  document.execCommand("copy");
  $temp.remove();

}
*/

    // can use this for copy to clipboard buttons within nodes
    // also inserts linebreaks for <li>, <br>, <p> Elements

    function copyToClipboard(element) {
        var text = $(element).clone().find('li,br,p').prepend('\r\n').end().text();
        element = $('<textarea>').appendTo('body').val(text).select();
        document.execCommand('copy');
        element.remove();
    }


    // copy the history-only

    function copyHistoryToClipboard(element) {
        var text;

        if (showing_answers_only)
            text = $(element).find(':visible').text(); // keep answers-only on one line (Dr. William)
        else
            text = $(element).clone().find('li,br,p').prepend('\r\n').end().text(); // Grab entire session history and line separate

        element = $('<textarea>').appendTo('body').val(text).select();
        document.execCommand('copy');
        element.remove();

    }

    // use this to copy notes into a Zendesk or Freshdesk ticket

    function copy_notes() {
        // get HTML from portion of nod edelimited by [[COPY-AREA]] and [[/COPY-AREA]]
        var notes = $(".node-content-copy-area:visible").html();

// clean up ##TRANSCRIPT## area for nice copy to notes

        // inline style zt-history-answer to italics
        notes = notes.replace(/class=\"zt-history-answer\"/g, 'style="font-style:italic"');

        // remove persistent button
        notes = notes.replace(/class=\"btn btn-default btn-sm\"/g, 'style="display:none"');


        parent.postMessage('NOTES:' + notes, '*');
    }


    // use this to copy the copy area to the clipboard

    function copy_to_clipboard() {
        // get HTML from portion of nod edelimited by [[COPY-AREA]] and [[/COPY-AREA]]
        var notes = $(".node-content-copy-area:visible").html();

// clean up ##TRANSCRIPT## area for nice copy to notes

        // inline style zt-history-answer to italics
        notes = notes.replace(/class=\"zt-history-answer\"/g, 'style="font-style:italic"');

        // remove persistent button
        notes = notes.replace(/class=\"btn btn-default btn-sm\"/g, 'style="display:none"');

        // copy it to the clipboard
        var $temp = $("<div>");
        $("body").prepend($temp);
        $temp.attr("contenteditable", true)
            .html(notes).select()
            .on("focus", function () {
                document.execCommand('selectAll', false, null);
            })
            .focus();
        document.execCommand("copy");
        $temp.remove();


    }


    // track a direct link via a link node

    function track_direct_link(link_node_id, button_text, resolution_state) {
        ++click_num;


        var request = $.ajax({
            url: tracking_url,
            method: "POST",
            data: {
                source: source,
                agent_mode: agent_mode,
                tree_id: trees[this_tree_id].tree_id,
                master_tree_id: master_tree_id,
                session_id: session_id,
                from: this_node_id,
                to: link_node_id,
                click_text: button_text,
                score: 0,
                form_data: form_data_string,
                resolution_state: resolution_state,
                instance: "2L",
                click_num: click_num
            },
            async: true,
            dataType: "html",
            uid: uid
        });

        request.done(function (msg) {
            log(msg);
        });

    }

    // Normal Hooks

    whenEvent("actionComplete", function(p) {
        console.log("actionComplete: received ", p);
        var b;
        if (null !== (b = findActionButton(p))) {
            do_button_click(b.button_link, trees[this_tree_id].nodes[this_node_id].project_node_id, b.button_text, b.value, '');
            return;
        }
        // see if there's a generic handler
        console.log("actionComplete: No specific button found, looking for '__process' button");
        if (null !== (b = findActionButton('process'))) {
            do_button_click(b.button_link, trees[this_tree_id].nodes[this_node_id].project_node_id, b.button_text, b.value, '');
        }
        return;
    });

    function findActionButton(a) {
        var target_name = '__' + a.trim().toLowerCase();
        var buttons = trees[this_tree_id].nodes[this_node_id]['buttons'];
        for (i in buttons) {
            var button  = buttons[i];
            // console.log(button);
            if (button.button_text == target_name) {
                return button;
            }
        };
        return null;
    }
</script>
<script>
        function add_tags(tags) {
        }

        function remove_tags(tags) {
        }


    </script>
<script>

    // let containing page know that variables have ben set

    function set_variable(name, value) {
        parent.postMessage('setvar:' + name + ':' + value, '*');
    }

</script>

<div id="session-notes-form" class="modal fade in" tabindex="-1" role="dialog" aria-labelledby="NotesLabel" aria-hidden="false">
<div class="modal-dialog ">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
<h4 class="modal-title" id="NotesLabel">Session Notes</h4>
</div>
<div class="modal-body">
<form role="form" class="form" id="notesform" action="#">
<input type="hidden" name="name" id="agent" value="Agent">
<div class="form-group">
<label for="comments" class="control-label">Enter Notes:</label>
<textarea class="form-control" rows="4" name="notes" id="notes" placeholder="Enter notes here..."></textarea>
</div>
<br>
<div class="form-group">
<input type="button" id="submit-note" class="btn btn-primary btn-lg" value="Submit Notes" onclick="submit_note(); return(false) ;">
</div>
</form>
</div>
<div class="modal-footer">
<div align="left">
<span id="last_entry"></span>
</div>
</div>
</div>
</div>
</div>
<script>
    
    function submit_note()
    {
        // update content area display
        
        $(".zt-session-notes").text($("#notes").val()) ;
        
        // update DB
        
        $.ajax({
            type: "POST",
            url: "/deploy/send-session-note.php", // add to session data
            data: { 
                agent: source,
                notes: $("#notes").val(),
                session_id: session_id                
             },
             
            success: function(msg){
//                alert("done") ;
                $("#notes").val('') ;                   // erase previous entry
                $("#session-notes-form").modal('hide'); // hide popup  
                
                $("#session-notes-button").removeClass("btn-success") ;
                $("#session-notes-button").addClass("btn-danger") ;
            },
            error: function(){
 //               alert("failure");
                $("#session-notes-form").modal('hide'); //hide popup  
                
            }
        });
    
        return (false) ;
                
    }
    
   
// get previously entered notes
    
function get_notes(place)
{
       
    $.ajax({
        type: "GET",
        url: "/api/rest/zingtree.php", // add to session data
        data: { 
            session_id: session_id,
            op: 'get_session_notes'             
         },
         
        success: function(obj){
            if (place == 'dlg')
                $("#notes").val(obj.notes) ;                   // insert previous notes
            else if (place == 'node')
                $(".zt-session-notes").text(obj.notes) ;       // insert notes into all content areas
            
        },
        error: function(){
//               alert("failure");
            
        }
    });

    return (false) ;
    
    
}
    
    
    </script>
<script src="/js/vendor/bootstrap/bootstrap.min.js"></script>
<script src="/js/iframeResizer.contentWindow.js"></script>
<script type="text/javascript" src="/js/browser-back.js"></script>
</body>
</html>
